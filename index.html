<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>紳士AI讚美產生器 (v11.5 SVG Final)</title>
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        ::-webkit-scrollbar { display: none !important; width: 0px !important; background: transparent !important; }
        html { height: auto; min-height: 100%; overflow-y: auto; overscroll-behavior-y: auto; -webkit-tap-highlight-color: transparent; touch-action: manipulation; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { margin: 0; padding: 0; background-color: var(--bg); color: var(--text); -webkit-text-size-adjust: 100%; width: 100%; transition: background-color 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), color 0.4s; -webkit-overflow-scrolling: touch; overflow-y: auto; height: auto; position: relative; }

        :root { 
            /* 基礎配色 */
            --primary: #007AFF; --secondary: #5AC8FA; --bg: #F2F2F7; --card: #FFFFFF; --text: #000000; --sub-text: #8E8E93; --border: rgba(0, 0, 0, 0.08); --hover: #F2F2F7; --active-bg: #007AFF; --active-text: #ffffff; --subtle-active-bg: #E5E5EA; --subtle-active-text: #000000; --section-bg: #F9F9F9; --result-bg: #FFFFFF; --result-right-bg: rgba(0, 0, 0, 0.03); --result-right-text: #8E8E93; --result-border: rgba(0, 0, 0, 0.05); --emo-bg: rgba(0, 122, 255, 0.1); --emo-text: #007AFF; --emo-border: transparent; --ad-bg-start: #FFFFFF; --ad-bg-end: #F2F2F7; --skeleton-base: #E5E5EA; --skeleton-highlight: #F2F2F7; --modal-bg: rgba(255, 255, 255, 0.92); --modal-overlay: rgba(0, 0, 0, 0.4); --btn-regen: #007AFF; --btn-emoji: #34C759; --fav-color: #FFCC00; --speak-color: #FF2D55; --delete-color: #FF3B30; --setting-group-bg: #FFFFFF; --fs-jp: 0.95rem; --fs-cn: 0.85rem; --ext-header-bg: #E0F2FE; --ext-header-text: #007AFF; --xp-bar-bg: #E5E5EA; --xp-bar-fill: #80BDFF; --ad-iframe-bg: #FFFFFF; --achieve-bg: #FFF9E6; --achieve-border: rgba(255, 204, 0, 0.2); --achieve-icon: #FF9500; --shadow-sm: none; --shadow-md: none; --btn-border-light: transparent; --btn-border-dark: rgba(0,0,0,0.1);
            --segment-bg: #E5E5EA;
        }
        
        html.dark-mode { 
            --bg: #000000; --card: #1C1C1E; --text: #FFFFFF; --sub-text: #98989D; --border: rgba(255, 255, 255, 0.1); --hover: #2C2C2E; --active-bg: #0A84FF; --active-text: #FFFFFF; --subtle-active-bg: #3A3A3C; --subtle-active-text: #FFFFFF; --section-bg: #2C2C2E; --result-bg: #1C1C1E; --result-right-bg: rgba(255, 255, 255, 0.05); --result-right-text: #98989D; --result-border: rgba(255, 255, 255, 0.08); --emo-bg: rgba(10, 132, 255, 0.15); --emo-text: #64D2FF; --emo-border: transparent; --ad-bg-start: #1C1C1E; --ad-bg-end: #000000; --skeleton-base: #2C2C2E; --skeleton-highlight: #3A3A3C; --modal-bg: rgba(30, 30, 30, 0.92); --modal-overlay: rgba(0, 0, 0, 0.6); --setting-group-bg: #1C1C1E; --ext-header-bg: #102A43; --ext-header-text: #64D2FF; --xp-bar-bg: #3A3A3C; --ad-iframe-bg: #1C1C1E; --achieve-bg: #3F2804; --achieve-border: #5C3A05; --achieve-icon: #FFD60A; --shadow-sm: none; --shadow-md: none; --btn-border-light: rgba(255,255,255,0.15); --btn-border-dark: transparent; 
            --segment-bg: #000000;
        }
        html.dark-mode .custom-ai-input { color: #FFFFFF !important; background-color: var(--card); }
        html.dark-mode .custom-ai-input::placeholder { color: rgba(255, 255, 255, 0.5); }

        html.theme-pink { --primary: #FB7DA8; --secondary: #FFB7CE; --btn-regen: #FB7DA8; --emo-text: #FB7DA8; --active-bg: #FB7DA8; --xp-bar-fill: #FFC2D6; }
        html.dark-mode.theme-pink { --primary: #FF85B3; --emo-text: #FF85B3; --active-bg: #FF85B3; --xp-bar-fill: #FF85B3; }
        html.theme-teal { --primary: #008ba3; --secondary: #5AC8FA; --btn-regen: #008ba3; --emo-text: #008ba3; --active-bg: #008ba3; --xp-bar-fill: #80DEEA; }
        html.theme-silver { --primary: #636366; --secondary: #AEAEB2; --btn-regen: #636366; --emo-text: #636366; --active-bg: #636366; --xp-bar-fill: #C7C7CC; --bg: #F2F2F7; }
        html.dark-mode.theme-silver { --bg: #000000; --card: #1C1C1E; --primary: #98989D; --btn-regen: #636366; }
        html.theme-gold { --primary: #F59E0B; --secondary: #FFCC00; --btn-regen: #F59E0B; --emo-text: #F59E0B; --active-bg: #F59E0B; --xp-bar-fill: #FFE082; --bg: #FFF9E6; }
        html.dark-mode.theme-gold { --bg: #000000; --primary: #FFD60A; }
        html.theme-orange { --primary: #F37021; --secondary: #FF9F55; --btn-regen: #F37021; --emo-text: #F37021; --active-bg: #F37021; --xp-bar-fill: #FFCC80; --bg: #FFF5EE; }
        html.dark-mode.theme-orange { --bg: #000000; --primary: #FF8C42; --emo-text: #FF8C42; }
        html.theme-purple { --primary: #AF52DE; --secondary: #BF5AF2; --btn-regen: #AF52DE; --emo-text: #AF52DE; --active-bg: #AF52DE; --xp-bar-fill: #E1BEE7; }
        html.theme-wine { --primary: #A00030; --secondary: #FF3B30; --btn-regen: #A00030; --emo-text: #A00030; --active-bg: #A00030; --xp-bar-fill: #EF9A9A; }
        html.theme-colorful { --primary: #FF2D55; --secondary: #AF52DE; --btn-regen: #FF2D55; --emo-text: #AF52DE; --active-bg: #FF2D55; --xp-bar-fill: #F48FB1; }
        html.theme-colorful .category-btn.active { background: linear-gradient(135deg, #FF2D55, #AF52DE); border: none; color: white; box-shadow: none; }
        html.theme-colorful .action-btn { background: linear-gradient(135deg, #007AFF, #AF52DE); border: none; color: white; font-weight: 800; }
        html.theme-colorful .btn-regen { background: linear-gradient(135deg, #34C759, #007AFF); color: white; font-weight: 800; border: none; }
        html.theme-colorful .btn-emoji-reroll { background: linear-gradient(135deg, #FF9500, #FFCC00); color: white; font-weight: 800; border: none; }
        html.theme-colorful .search-btn { background: linear-gradient(135deg, #FF9500, #FF2D55); border: none; color: white; box-shadow: none; }
        html.theme-colorful .tab-btn.active { background: linear-gradient(135deg, #AF52DE, #FF2D55); border: none; color: white; box-shadow: none; }
        html.theme-colorful .theme-btn.active { background: linear-gradient(135deg, #34C759, #007AFF); border: none; color: white; box-shadow: none; }
        html.theme-colorful .welcome-header-pill { background: linear-gradient(90deg, #FF2D55, #AF52DE); }
        html.theme-colorful .control-option.active { color: #AF52DE !important; border-color: transparent !important; }

        html.theme-mono { filter: grayscale(100%); --primary: #333; --secondary: #666; --btn-regen: #333; --btn-emoji: #333; --active-bg: #333; --emo-text: #000; --emo-bg: #E5E5EA; --xp-bar-fill: #BDBDBD; --fav-color: #666; --bg: #F2F2F7; --card: #FFF; }
        html.dark-mode.theme-mono { --bg: #000; --card: #1C1C1E; --primary: #8E8E93; --btn-regen: #3A3A3C; --btn-emoji: #3A3A3C; --active-bg: #3A3A3C; --emo-text: #FFF; --emo-bg: #2C2C2E; --xp-bar-fill: #616161; --fav-color: #8E8E93; }

        html.theme-twitter { --bg: #FFFFFF; --card: #FFFFFF; --text: #0F1419; --sub-text: #536471; --border: #EFF3F4; --hover: #F7F9F9; --section-bg: #F7F9F9; --primary: #1D9BF0; --active-bg: #0F1419; --active-text: #FFFFFF; --subtle-active-bg: #CFD9DE; --subtle-active-text: #0F1419; --btn-regen: #1D9BF0; --emo-text: #1D9BF0; --ext-header-bg: #F7F9F9; --ext-header-text: #0F1419; --xp-bar-fill: #A5DDF9; --result-bg: #FFFFFF; --result-right-bg: #F7F9F9; --result-right-text: #536471; --result-border: #EFF3F4; --shadow-sm: none; --shadow-md: none; }
        html.theme-twitter .category-btn { border: 1px solid #CFD9DE; background: #FFFFFF; }
        html.theme-twitter .category-btn.active { background: #0F1419; color: #FFFFFF; border-color: #0F1419; }
        html.theme-twitter .action-btn { border: 1px solid #CFD9DE; }
        html.theme-twitter .result-item { border: 1px solid #EFF3F4; }
        html.theme-twitter .group-section { border: 1px solid #EFF3F4; }
        html.theme-twitter .search-input { border: 1px solid #CFD9DE; background: #EFF3F4; }
        html.theme-twitter .search-input:focus { background: #FFFFFF; border-color: #1D9BF0; }

        html.dark-mode.theme-twitter { --bg: #000000; --card: #000000; --text: #E7E9EA; --sub-text: #71767B; --border: #2F3336; --hover: #16181C; --section-bg: #16181C; --primary: #1D9BF0; --active-bg: #EFF3F4; --active-text: #0F1419; --subtle-active-bg: #333639; --subtle-active-text: #EFF3F4; --btn-regen: #1D9BF0; --emo-text: #1D9BF0; --ext-header-bg: #16181C; --ext-header-text: #EFF3F4; --xp-bar-fill: #6BC9FB; --result-bg: #000000; --result-right-bg: #16181C; --result-right-text: #71767B; --result-border: #2F3336; --shadow-sm: none; --shadow-md: none; }
        html.dark-mode.theme-twitter .category-btn { border: 1px solid #333639; background: #000000; }
        html.dark-mode.theme-twitter .category-btn.active { background: #EFF3F4; color: #000000; border-color: #EFF3F4; }
        html.dark-mode.theme-twitter .action-btn { border: 1px solid #333639; }
        html.dark-mode.theme-twitter .result-item { border: 1px solid #2F3336; }
        html.dark-mode.theme-twitter .group-section { border: 1px solid #2F3336; }
        html.dark-mode.theme-twitter .search-input { border: 1px solid #333639; background: #202327; }
        html.dark-mode.theme-twitter .search-input:focus { border-color: #1D9BF0; background: #000000; }

        html.theme-fanbox { --primary: #F5C500; --secondary: #FFEA66; --btn-regen: #F5C500; --emo-text: #B8860B; --active-bg: #F5C500; --active-text: #000000; --xp-bar-fill: #FFF59D; --bg: #F8F8F8; }
        html.dark-mode.theme-fanbox { --bg: #000000; --primary: #FFD800; --active-text: #000000; --emo-text: #FFD800; }
        html.theme-youtube { --primary: #FF0000; --secondary: #FF4444; --btn-regen: #FF0000; --emo-text: #CC0000; --active-bg: #FF0000; --xp-bar-fill: #EF9A9A; }
        html.dark-mode.theme-youtube { --emo-text: #FF4444; }
        html.theme-tech { --primary: #0070F3; --secondary: #50E3C2; --btn-regen: #0070F3; --emo-text: #0070F3; --active-bg: #0070F3; --active-text: #FFFFFF; --xp-bar-fill: #90CAF9; --bg: #F0F5FF; }
        html.dark-mode.theme-tech { --primary: #00F0FF; --secondary: #00B8FF; --btn-regen: #00F0FF; --emo-text: #00F0FF; --active-bg: #00F0FF; --active-text: #000000; --xp-bar-fill: #80DEEA; --bg: #050A14; --card: #0A1428; --text: #E0F0FF; --border: rgba(0, 240, 255, 0.2); }
        html.theme-plurk { --primary: #CF473E; --secondary: #FF8077; --btn-regen: #CF473E; --emo-text: #CF473E; --active-bg: #CF473E; --xp-bar-fill: #EF9A9A; --bg: #FDF6E3; }
        html.dark-mode.theme-plurk { --bg: #1A1A1A; --primary: #FF574D; --emo-text: #FF574D; }
        html.theme-melon { --primary: #66CC33; --secondary: #88DD55; --btn-regen: #66CC33; --emo-text: #448822; --active-bg: #66CC33; --xp-bar-fill: #C5E1A5; }
        html.dark-mode.theme-melon { --emo-text: #66CC33; }

        body.pure-mode .ui-icon { display: none !important; }
        body.pure-mode .category-btn.featured { background: var(--card); color: var(--text); border-color: var(--border); }
        body.hide-fun .xp-container { display: none !important; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes simpleFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes shimmer { 0% { transform: translateX(-150%) rotate(30deg); } 100% { transform: translateX(150%) rotate(30deg); } }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } 100% { transform: rotate(0deg); } }
        @keyframes flyOut { to { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        @keyframes popInDropdown { 0% { opacity: 0; transform: scale(0.9) translateY(-10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes modalPopIn { 0% { opacity: 0; transform: scale(0.95) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes pressBounce { 0% { transform: scale(1); } 50% { transform: scale(0.92); } 100% { transform: scale(1); } }
        @keyframes trophyPop { 0% { transform: scale(0); } 60% { transform: scale(1.3); } 100% { transform: scale(1); } }
        @keyframes fadeOutUp { 0% { opacity: 1; margin-top: -10px; } 100% { opacity: 0; margin-top: -40px; } }
        @keyframes pulseText { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        .container { max-width: 900px; margin: 0 auto; background: var(--card); min-height: auto; height: auto; padding: 10px 12px 50px 12px; box-sizing: border-box; display: flex; flex-direction: column; transition: background-color 0.3s, box-shadow 0.3s; position: relative; }
        @media (min-width: 600px) { body { padding: 30px; } .container { border-radius: 48px; box-shadow: var(--shadow-md); padding: 40px 30px; } }
        
        .header-row { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            margin-bottom: 12px; 
            min-height: 40px; 
            padding: 0 4px;
            margin-top: -6px;
        }

        @media (max-width: 600px) {
            .header-row {
                justify-content: flex-start;
                padding-top: 12px; 
                padding-left: 8px;
                align-items: center; 
            }
            h1 {
                text-align: left;
                width: auto;
                font-size: 0.8rem; 
                transform: scale(0.9);
                transform-origin: left center; 
                line-height: 1.2;
                margin-left: 5px;
            }
        }

        h1 { 
            font-size: 1.4rem; 
            margin: 0; 
            color: var(--text); 
            font-weight: 800; 
            letter-spacing: -0.02em; 
            width: 100%; 
            text-align: center; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        h1 svg {
            width: 1.3em;
            height: 1.3em;
            fill: var(--text);
        }
        
        @media (max-width: 600px) {
            h1 { justify-content: flex-start; }
        }
        
        .settings-hitbox { 
            position: absolute; 
            right: 0; 
            top: 50%;
            transform: translateY(-50%);
            width: 48px; 
            height: 48px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 20; 
            cursor: pointer; 
        }
        @media (max-width: 600px) {
            .settings-hitbox {
                top: 60%; 
            }
        }
        .settings-visual { width: 38px; height: 38px; background-color: var(--section-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; color: var(--text); transition: transform 0.2s, background-color 0.2s; box-shadow: var(--shadow-sm); }
        .settings-hitbox.active .settings-visual { transform: scale(0.9) translateY(-50%); background-color: var(--hover); }

        .xp-container { margin-top: 24px; margin-bottom: 6px; padding: 0 4px; cursor: pointer; user-select: none; }
        .xp-info { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px; font-size: 0.75rem; font-weight: 600; color: var(--sub-text); margin-top: 0; }
        .xp-title { color: var(--sub-text); font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .xp-badge { background: transparent; color: var(--sub-text); border: 1px solid var(--sub-text); padding: 2px 8px; border-radius: 20px; font-size: 0.65rem; margin-right: 4px; font-weight: 700; }
        html.dark-mode .xp-badge { color: var(--sub-text); border: 1px solid var(--sub-text); }
        .xp-bar-bg { width: 100%; height: 8px; background-color: var(--xp-bar-bg); border-radius: 10px; overflow: hidden; position: relative; }
        .xp-bar-fill { height: 100%; width: 0%; background-color: var(--xp-bar-fill); border-radius: 10px; transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        .xp-popover { display: none; position: fixed; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; z-index: 5000; width: 280px; background-color: var(--modal-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 32px; box-shadow: var(--shadow-md); padding: 0; animation: popInDropdown 0.25s cubic-bezier(0.2, 0.8, 0.2, 1); overflow: hidden; }
        .xp-popover-header { background: rgba(0,0,0,0.03); padding: 12px 16px; border-bottom: 1px solid var(--border); font-weight: 700; display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; color: var(--text); }
        .xp-popover-close { cursor: pointer; padding: 4px; opacity: 0.5; font-size: 1.2rem; }
        .xp-popover-content { padding: 16px; max-height: none; overflow-y: visible; }
        
        .xp-rule-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.85rem; color: var(--sub-text); }
        .xp-rule-val { font-weight: 700; color: var(--primary); }
        .xp-list-title { font-size: 0.8rem; color: var(--text); font-weight: 700; margin: 16px 0 8px 0; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
        .xp-list-item { font-size: 0.8rem; color: var(--sub-text); padding: 4px 0; display: flex; justify-content: space-between; }
        .xp-list-item.locked { opacity: 0.4; }
        .xp-list-item.unlocked { color: var(--text); font-weight: 600; }

        /* 緊湊化修改：減少 margin-bottom */
        .group-section { background-color: var(--section-bg); border-radius: 32px; margin-top: 10px; margin-bottom: 8px; border: none; box-shadow: var(--shadow-sm); overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s ease; }
        
        .panel-header { padding: 12px 16px; background: transparent; border-bottom: none; color: var(--text); font-size: 0.9rem; font-weight: 800; display: flex; align-items: center; justify-content: space-between; letter-spacing: 0.02em; cursor: pointer; }
        html.dark-mode .panel-header { background: transparent; }
        .panel-header-sub { font-size: 0.75rem; opacity: 0.6; font-weight: normal; margin-left: auto; }
        .panel-content { padding: 0 10px 10px 10px; }
        .panel-content.hidden { display: none; }
        .section-title { display: none; }
        .sub-placeholder { text-align: center; color: var(--sub-text); font-size: 0.85rem; padding: 10px; width: 100%; }
        
        .dict-arrow { transition: transform 0.3s ease; display: inline-block; font-size: 0.8rem; margin-left: 6px; opacity: 0.6; }
        
        .control-option { 
            flex: 1; 
            text-align: center; 
            padding: 8px 0; 
            font-size: 0.82rem; 
            cursor: pointer; 
            border-radius: 8px; 
            color: var(--sub-text); 
            font-weight: 500; 
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); 
            white-space: nowrap; 
            overflow: hidden; 
            border: none;
            background: transparent;
            margin: 0;
        }
        .control-option.active { 
            background-color: var(--card); 
            color: var(--text); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            font-weight: 700;
            border: none;
        }

        .category-btn { 
            color: var(--text); 
            font-weight: 500; 
            opacity: 0.9; 
            padding: 3px; 
            border: none; 
            background: var(--card); 
            border-radius: 99px; 
            font-size: 0.96rem; 
            cursor: pointer; 
            text-align: center; 
            user-select: none; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 36px; 
            line-height: 1.1; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); 
            box-shadow: none;
        }
        .category-btn.active { background-color: var(--active-bg); color: var(--active-text); font-weight: 700; box-shadow: none; transform: scale(1.02); }
        
        @media (max-width: 600px) {
            .category-btn {
                font-size: 0.85rem; 
                min-height: 32px;
                padding: 2px;
            }
        }

        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        @media (min-width: 600px) { 
            .grid-container { grid-template-columns: repeat(7, 1fr); gap: 6px; } 
            .category-btn { padding: 4px; } 
        }
        
        /* 緊湊化修改：減少 margin */
        .ai-input-container {
            background-color: var(--section-bg);
            border-radius: 32px;
            margin-top: 8px;
            margin-bottom: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: var(--shadow-sm);
        }
        
        .custom-ai-input { flex: 1; padding: 12px 20px; border-radius: 50px; font-size: 0.95rem; outline: none; transition: all 0.2s ease; background-color: var(--card); border: 1px solid var(--border); box-shadow: none; width: 100%; box-sizing: border-box; }
        .custom-ai-input:focus { background: var(--card); border-color: var(--primary); box-shadow: none; }
        
        .btn-custom-ai { width: 90px; padding: 12px 0; border-radius: 50px; font-size: 0.95rem; font-weight: 800; cursor: pointer; border: none; color: white; background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); box-shadow: none; position: relative; overflow: hidden; white-space: nowrap; }
        .btn-custom-ai::after { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%); transform: rotate(30deg); animation: shimmer 3s infinite; pointer-events: none; }
        .btn-custom-ai.disabled { background: var(--border); color: var(--sub-text); cursor: not-allowed; box-shadow: none; }
        .btn-custom-ai.disabled::after { display: none; }

        .action-grid { display: flex; flex-direction: column; gap: 12px; }
        
        /* 新的統一控制面板 (Control Deck) */
        .unified-control-panel {
            background-color: var(--section-bg);
            border-radius: 32px;
            padding: 12px;
            margin-top: 12px;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* 按鈕行，增加間距，不再太緊 */
        .action-row {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        
        .action-btn { flex: 1; padding: 12px 0; border-radius: 50px; font-size: 0.9rem; font-weight: 700; cursor: pointer; text-align: center; color: white; box-shadow: none; transition: transform 0.1s, box-shadow 0.2s; -webkit-tap-highlight-color: transparent; user-select: none; display: flex; align-items: center; justify-content: center; gap: 4px; }
        @media (max-width: 600px) {
            .action-btn { font-size: 0.8rem; }
        }
        
        .action-btn:active { transform: scale(0.96); box-shadow: none; }
        .action-btn.disabled { background-color: var(--border); color: var(--sub-text); cursor: not-allowed; pointer-events: none; box-shadow: none; border: none; }
        .btn-regen { background-color: var(--primary); }
        .btn-emoji-reroll { background-color: var(--primary); color: #FFFFFF; }
        
        .btn-ai-batch { background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); color: white; position: relative; overflow: hidden; }
        .btn-ai-batch::after { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%); transform: rotate(30deg); animation: shimmer 3s infinite; pointer-events: none; }

        .search-block { margin-top: 2px; margin-bottom: 10px; padding: 10px; background-color: var(--section-bg); border-radius: 32px; border: none; display: flex; flex-direction: column; gap: 10px; }
        .search-box { display: flex; gap: 8px; width: 100%; order: 2; }
        .history-group { display: flex; gap: 8px; width: 100%; order: 1; }
        .search-input { flex: 1; padding: 12px 20px; border: none; border-radius: 50px; font-size: 0.95rem; outline: none; background: var(--card); color: var(--text); transition: all 0.2s ease; box-shadow: none; }
        .search-input:focus { background: var(--card); box-shadow: 0 0 0 2px var(--primary); }
        .search-btn { width: 70px; background-color: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 50px; font-size: 0.95rem; font-weight: 700; cursor: pointer; box-shadow: none; }
        
        @media (max-width: 600px) {
            .search-btn { font-size: 0.8rem; }
        }
        
        .history-btn { flex: 1; padding: 10px 0; background-color: var(--card); border: none; border-radius: 50px; color: var(--text); font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; box-shadow: none; }
        .history-btn:active { transform: scale(0.96); background-color: var(--hover); }
        @media (min-width: 600px) { .search-block { flex-direction: row; align-items: center; padding: 12px; } .history-group { flex: 1; order: 1; margin-right: 12px; } .search-box { flex: 1.2; order: 2; margin-bottom: 0; } }

        .result-item { background-color: var(--result-bg); border: none; border-radius: 32px; cursor: pointer; position: relative; display: flex; overflow: hidden; -webkit-user-select: none; user-select: none; box-shadow: none; min-height: 50px; transition: transform 0.1s, background-color 0.1s; opacity: 0; }
        .result-item.animate-in { animation: fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .result-item.fade-in { animation: simpleFadeIn 0.2s ease-out forwards; }
        .result-item:active { transform: scale(0.95) !important; transition: 0.05s; }
        .result-item.clicked { background-color: var(--hover); transform: scale(0.95); transition: 0.1s; border: 1px solid var(--primary); }
        .result-left { flex: 1; padding: 10px 20px; font-size: var(--fs-jp); line-height: 1.4; color: var(--text); word-break: break-all; display: flex; align-items: center; font-weight: 500; flex-wrap: wrap; }
        .result-actions { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 44px; background-color: transparent; padding: 0; border-left: 1px solid var(--result-border); }
        .action-icon { flex: 1; width: 100%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; opacity: 0.4; transition: all 0.2s; border-radius: 0; }
        .action-icon:hover { opacity: 1; background-color: var(--hover); }
        .icon-speak:hover { color: var(--speak-color); }
        .icon-star.active { color: var(--fav-color); opacity: 1; }
        .icon-star:hover { color: var(--fav-color); }
        .result-right { width: 90px; flex-shrink: 0; background-color: var(--result-right-bg); padding: 6px 6px 6px 10px; display: flex; align-items: center; justify-content: flex-start; text-align: left; font-size: var(--fs-cn); color: var(--result-right-text); border-left: 1px solid var(--result-border); font-weight: 500; line-height: 1.3; flex-wrap: wrap; }
        .hide-cn .result-right { display: none; }
        .hide-speak .icon-speak { display: none; }
        .particle { pointer-events: none; position: fixed; font-size: 1.2rem; animation: flyOut 0.8s forwards; z-index: 9999; }
        @media (min-width: 600px) { .result-left { font-size: calc(var(--fs-jp) + 0.2rem); } .result-right { width: 220px; font-size: calc(var(--fs-cn) + 0.2rem); } .result-actions { flex-direction: row; width: auto; padding: 0; } .action-icon { width: 44px; height: 100%; } }

        .footer-control-area { margin-top: 30px; padding-top: 10px; display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%; }
        .footer-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
        @media (min-width: 600px) { .footer-btn-grid { grid-template-columns: repeat(4, 1fr); max-width: 60%; margin: 0 auto; } }
        
        .footer-action-btn { display: flex; align-items: center; justify-content: center; gap: 6px; background-color: transparent; color: #000000; padding: 8px 0; border-radius: 50px; text-decoration: none; font-size: 0.8rem; font-weight: 700; box-shadow: none; transition: transform 0.1s, opacity 0.2s; border: 1px solid #8E8E93; }
        html.dark-mode .footer-action-btn { background-color: #2C2C2E; border: 1px solid rgba(255,255,255,0.1); color: #FFFFFF; }
        
        .footer-action-btn:active { transform: scale(0.96); }
        .footer-desc { text-align: center; font-size: 0.7rem; color: var(--sub-text); line-height: 1.5; opacity: 0.8; font-weight: 500; max-width: 90%; }

        .toast { visibility: hidden; min-width: 140px; background-color: var(--modal-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: var(--text); text-align: center; border-radius: 50px; padding: 12px 20px; position: fixed; z-index: 10000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 0.9rem; } 
        .toast.show { visibility: visible; opacity: 1; }
        .loading { text-align: center; padding: 15px; color: var(--sub-text); font-weight: 600; font-size: 0.85rem; }
        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
        @media (min-width: 600px) { .theme-grid { grid-template-columns: repeat(3, 1fr); } }
        .theme-btn { padding: 8px; border: none; background: var(--section-bg); border-radius: 20px; cursor: pointer; font-size: 0.8rem; color: var(--text); text-align: center; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; justify-content: center; min-height: 32px; box-shadow: none; }
        .theme-btn.active { background: var(--active-bg); color: var(--active-text); box-shadow: none; transform: scale(1.02); }
        .theme-btn.disabled { opacity: 0.4; background: var(--bg); color: var(--sub-text); box-shadow: none; pointer-events: none; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: var(--modal-overlay); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); animation: simpleFadeIn 0.3s; }
        .modal-content { background-color: var(--modal-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); margin: 0 auto; padding: 24px; border: 1px solid rgba(255,255,255,0.1); border-radius: 32px; width: 90%; max-width: 500px; box-shadow: var(--shadow-md); position: relative; box-sizing: border-box; display: flex; flex-direction: column; max-height: 75vh; top: 12%; animation: modalPopIn 0.4s cubic-bezier(0.19, 1, 0.22, 1) forwards; will-change: transform, opacity; }
        #modal-content-box, #achieve-content-box { top: 80px !important; max-height: calc(100vh - 120px); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-weight: 800; font-size: 1.1rem; color: var(--text); letter-spacing: -0.01em; }
        .close-x { color: var(--sub-text); font-size: 1.4rem; font-weight: 600; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.05); border-radius: 50%; transition: background 0.2s; }
        .close-x:active { background: rgba(0,0,0,0.1); }
        .tab-group { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px; background: var(--section-bg); padding: 4px; border-radius: 50px; border: none; justify-content: flex-start; }
        .tab-btn { width: 32%; flex: 1; padding: 8px 4px; text-align: center; font-size: 0.8rem; font-weight: 600; cursor: pointer; color: var(--sub-text); border-radius: 50px; transition: all 0.2s; border: none; background-color: transparent; }
        .tab-btn.active { background-color: var(--card); color: var(--text); box-shadow: none; }
        .history-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 4px; }
        .history-item { padding: 14px; background-color: var(--section-bg); border-radius: 32px; font-size: 0.9rem; color: var(--text); cursor: pointer; border: none; transition: transform 0.1s, background-color 0.2s; word-break: break-all; display: flex; justify-content: space-between; align-items: center; }
        .history-item:active, .history-item.clicked { transform: scale(0.95); background-color: var(--hover); }
        .history-text { flex: 1; margin-right: 12px; font-weight: 500; }
        .delete-btn { color: var(--sub-text); padding: 8px; font-size: 1.1rem; cursor: pointer; border-radius: 8px; }
        .delete-btn:hover { color: var(--delete-color); background-color: rgba(255, 59, 48, 0.1); }
        .history-empty { text-align: center; color: var(--sub-text); padding: 30px; font-size: 0.95rem; }
        .modal-footer { margin-top: 20px; padding-top: 0; display: flex; flex-direction: column; gap: 10px; border: none; }
        .close-btn-full { width: 100%; padding: 14px; background-color: var(--bg); color: var(--text); border: none; border-radius: 50px; font-weight: 700; cursor: pointer; font-size: 1rem; }
        .clear-btn { width: 100%; padding: 14px; background-color: transparent; color: var(--delete-color); border: 1px solid var(--delete-color); border-radius: 50px; font-weight: 700; cursor: pointer; }
        .clear-btn:active { background-color: rgba(255, 59, 48, 0.05); }
        
        #welcome-modal { display: none; position: fixed; z-index: 6000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); animation: simpleFadeIn 0.3s; }
        .welcome-content { background: var(--modal-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-radius: 32px; padding: 0; text-align: center; width: 85%; max-width: 340px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 24px 60px rgba(0,0,0,0.25); overflow: hidden; position: fixed; top: 15% !important; left: 50% !important; transform: translateX(-50%) !important; margin: 0 auto; animation: modalPopIn 0.5s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
        .welcome-card-inner { padding: 30px 24px 36px 24px; background: linear-gradient(180deg, var(--card) 0%, var(--section-bg) 100%); position: relative; display: flex; flex-direction: column; align-items: center; border: 2px solid transparent; border-radius: 32px 32px 0 0; transition: all 0.3s; }
        .welcome-header-group { display: flex; flex-direction: column; align-items: center; width: 100%; margin-bottom: 20px; }
        .welcome-header-pill { background: var(--primary); color: white; padding: 8px 20px; border-radius: 50px; font-size: 0.9rem; font-weight: 700; margin-bottom: 10px; box-shadow: 0 6px 16px rgba(0, 122, 255, 0.25); letter-spacing: 0.05em; z-index: 2; }
        .modal-date-row { display: flex; align-items: center; justify-content: center; width: 100%; gap: 12px; color: var(--sub-text); font-size: 0.8rem; font-weight: 600; opacity: 0.8; }
        .modal-date-row::before, .modal-date-row::after { content: ""; height: 1px; background: var(--border); flex: 1; max-width: 50px; }
        .welcome-body { position: relative; width: 100%; }
        .welcome-emoji { font-size: 4.5rem; margin-bottom: 16px; animation: shake 3s infinite; display: inline-block; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.1)); }
        .welcome-text { font-size: 1.4rem; font-weight: 800; color: var(--text); margin-bottom: 10px; line-height: 1.4; }
        .welcome-sub { font-size: 0.9rem; color: var(--sub-text); font-weight: 500; }
        .welcome-actions { display: flex; gap: 10px; padding: 16px; background: var(--section-bg); border-top: 1px solid var(--border); border-radius: 0 0 32px 32px; }
        .welcome-btn { flex: 1; padding: 14px 4px; border-radius: 50px; font-size: 0.9rem; font-weight: 700; cursor: pointer; border: none; transition: transform 0.1s; white-space: nowrap; }
        .btn-dl-img { background: var(--card); color: var(--text); box-shadow: none; }
        .btn-copy-txt { background: var(--card); color: var(--text); box-shadow: none; }
        .btn-start { background: var(--primary); color: white; box-shadow: 0 6px 20px rgba(0, 122, 255, 0.3); flex: 1.5; }

        #achieve-toast { visibility: hidden; min-width: 220px; background-color: var(--modal-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: var(--text); border: 1px solid var(--achieve-icon); border-radius: 24px; padding: 20px; position: fixed; z-index: 10001; left: 50%; top: 15%; transform: translateX(-50%) scale(0.8); text-align: center; box-shadow: var(--shadow-md); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #achieve-toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) scale(1); }
        .achieve-toast-icon { font-size: 3rem; margin-bottom: 8px; animation: trophyPop 0.6s; display: inline-block; }
        .achieve-toast-title { font-weight: 800; font-size: 1.2rem; color: var(--achieve-icon); margin-bottom: 4px; }
        .achieve-toast-desc { font-size: 0.9rem; color: var(--sub-text); }
        .achieve-popover-fixed { display: none; position: fixed; z-index: 8000; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .achieve-detail-card { position: absolute; width: 280px; background: var(--modal-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); overflow: hidden; animation: popInDropdown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: center center; }
        .achieve-item { padding: 5px 10px; background-color: var(--card); border: 1px solid transparent; border-radius: 24px; display: flex; align-items: center; gap: 10px; opacity: 0.5; filter: grayscale(1); transition: all 0.3s; min-height: 34px; box-shadow: none; }
        .achieve-item.unlocked { opacity: 1; filter: grayscale(0); background-color: var(--achieve-bg); border-color: var(--achieve-border); box-shadow: none; }
        .achieve-icon { font-size: 1.2rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.5); border-radius: 50%; flex-shrink: 0; }
        .achieve-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .achieve-title { font-weight: 800; font-size: 0.8rem; color: var(--text); margin: 0; display: flex; justify-content: space-between; align-items: center; line-height: 1.2; }
        .achieve-desc { font-size: 0.7rem; color: var(--sub-text); line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }
        .achieve-date { font-size: 0.6rem; color: var(--primary); font-weight: 600; margin-left: 6px; background: rgba(0,0,0,0.05); padding: 1px 5px; border-radius: 8px; }

        .setting-group { margin-bottom: 20px; border-radius: 32px; overflow: hidden; box-shadow: none; border: none; }
        .setting-group-header { background-color: transparent; padding: 0 0 8px 12px; font-size: 0.8rem; font-weight: 600; color: var(--sub-text); text-transform: uppercase; letter-spacing: 0.05em; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 14px; border-bottom: 1px solid var(--border); background: var(--setting-group-bg); }
        .setting-row:last-child { border-bottom: none; }
        .setting-label { font-size: 0.9rem; font-weight: 500; color: var(--text); }
        .setting-control { display: flex; align-items: center; gap: 8px; flex: 1; justify-content: flex-end; }
        .slider-val-display { font-weight:700; color:var(--primary); width:20px; text-align:right; font-size:0.9rem; margin-left:6px; }
        input[type=range] { -webkit-appearance: none; width: 100%; max-width: 120px; height: 6px; background: var(--border); border-radius: 10px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; border-radius: 50%; background: white; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); border: 0.5px solid rgba(0,0,0,0.04); }
        .switch { position: relative; display: inline-block; width: 46px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E9E9EA; transition: .3s; border-radius: 30px; }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 2px; bottom: 2px; background-color: white; transition: .3s cubic-bezier(0.2, 0.8, 0.2, 1); border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }
        .switch.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        .dark-mode .slider { background-color: #39393D; }
        .font-btn { padding: 6px 12px; border: none; background: var(--bg); border-radius: 20px; cursor: pointer; font-size: 0.85rem; color: var(--text); font-weight: 500; }
        .font-btn.active { background: var(--active-bg); color: var(--active-text); }
        .font-btn.disabled { opacity: 0.5; background: var(--bg); color: var(--sub-text); }
        .emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap: 6px; padding: 5px; }
        .emoji-chip { padding: 4px; background-color: var(--section-bg); border: none; border-radius: 16px; font-size: 1.1rem; cursor: pointer; user-select: none; transition: all 0.2s; box-shadow: none; display: flex; align-items: center; justify-content: center; min-height: 36px; }
        .emoji-chip:active { transform: scale(0.9); }
        .emoji-chip.disabled { opacity: 0.3; filter: grayscale(100%); background-color: transparent; box-shadow: none; border: 1px dashed var(--sub-text); }
        .emoji-input-group { display: flex; gap: 8px; margin-bottom: 12px; }
        .emoji-input { flex: 1; padding: 10px; border: none; border-radius: 12px; background: var(--section-bg); color: var(--text); font-size: 0.9rem; }
        .emoji-add-btn { padding: 0 16px; background: var(--primary); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 0.9rem; }
        .help-banner { background: linear-gradient(to right, var(--ext-header-bg), var(--section-bg)); color: var(--ext-header-text); padding: 18px; border-radius: 32px; margin-bottom: 24px; display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; border: none; gap: 10px; font-size: 0.95rem; box-shadow: none; }
        .help-banner:active { transform: scale(0.98); filter: brightness(0.95); }
        .share-x-btn { background-color: #000000; color: white; width: 100%; margin: 12px 0 0 0; padding: 14px; border-radius: 50px; font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; border: none; text-decoration: none; transition: opacity 0.2s; box-sizing: border-box; box-shadow: none; }
        .share-x-btn:hover { opacity: 0.85; }
        .dark-mode .share-x-btn { background-color: #ffffff; color: #000000; }
        .tutorial-content { padding: 0 8px; }
        .tutorial-block { margin-bottom: 24px; }
        .tutorial-block h3 { margin: 0 0 12px 0; font-size: 0.95rem; color: var(--primary); background-color: rgba(0, 122, 255, 0.05); border: 1px solid rgba(0, 122, 255, 0.2); padding: 8px 16px; border-radius: 50px; display: inline-block; text-align: center; width: 100%; box-sizing: border-box; font-weight: 700; }
        .tutorial-block p { font-size: 0.9rem; line-height: 1.6; color: var(--text); margin: 0 0 10px 0; padding: 0 8px; }
        .tutorial-block ul { margin: 0; padding-left: 24px; }
        .tutorial-block li { font-size: 0.9rem; color: var(--sub-text); margin-bottom: 6px; line-height: 1.5; }
        .tutorial-block code { background: var(--section-bg); padding: 2px 6px; border-radius: 6px; font-family: monospace; color: var(--primary); font-weight: 600; border: 1px solid var(--border); }
        .backup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px; background: var(--setting-group-bg); }
        .backup-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px 8px; background: var(--section-bg); border-radius: 32px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; gap: 6px; }
        .backup-btn:active { transform: scale(0.96); background: var(--hover); }
        .backup-icon { font-size: 1.5rem; margin-bottom: 4px; }
        .backup-label { font-size: 0.85rem; font-weight: 600; color: var(--text); }
        @keyframes magicalPulse { 0% { transform: scale(1); box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-color: transparent; opacity: 1; } 30% { transform: scale(1.03); box-shadow: 0 0 20px var(--emo-bg); border: 2px solid var(--primary); background-color: var(--section-bg); opacity: 1; } 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 2px solid transparent; opacity: 1; } }
        .result-item.ai-upgraded { opacity: 1 !important; animation: magicalPulse 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 10; position: relative; }
        @keyframes textShimmer { 0% { opacity: 0; transform: translateY(5px); } 100% { opacity: 1; transform: translateY(0); } }
        .text-upgraded { animation: textShimmer 0.4s ease-out forwards; }
        @keyframes shakeReject { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-6px); } 40% { transform: translateX(6px); } 60% { transform: translateX(-3px); } 80% { transform: translateX(3px); } }
        .shake-limit { animation: shakeReject 0.4s ease-in-out; background-color: #ff5e5e !important; color: white !important; border-color: #ff5e5e !important; }
        .locked-tooltip { position: fixed; background: rgba(0, 0, 0, 0.85); color: white; padding: 8px 16px; border-radius: 50px; font-size: 0.85rem; font-weight: 700; z-index: 10000; pointer-events: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); white-space: nowrap; transform: translate(-50%, -100%); animation: tooltipFloatUp 2s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
        @keyframes tooltipFloatUp { 0% { opacity: 0; margin-top: 5px; transform: translate(-50%, -80%) scale(0.9); } 15% { opacity: 1; margin-top: 0; transform: translate(-50%, -100%) scale(1); } 80% { opacity: 1; margin-top: -10px; } 100% { opacity: 0; margin-top: -30px; transform: translate(-50%, -100%) scale(1); } }

        .section-divider {
            border: 0;
            height: 1px;
            background: var(--border);
            margin: 2px 16px 2px 16px; 
        }

        .panel-header.sub-header {
            padding-top: 5px;
        }

        /* Status Bar Style */
        .status-tips-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin: 12px 0 6px 0;
            padding: 0 8px;
            box-sizing: border-box;
        }

        .status-indicator {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0.9;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--sub-text);
            opacity: 0.5;
            display: inline-block;
        }

        .status-indicator.pulsing {
            animation: pulseText 1.5s infinite;
        }

        .tips-text-right {
            font-size: 0.65rem;
            color: var(--sub-text);
            text-align: right;
            opacity: 0.7;
            margin-left: 10px;
            font-weight: 500;
            flex-shrink: 0;
        }

        @media (max-width: 450px) {
            .status-indicator { font-size: 0.7rem; }
            .tips-text-right { font-size: 0.6rem; max-width: 140px; }
        }

        .result-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 0;
            padding: 0;
            min-height: auto;
        }

        .empty-state {
            border: 2px dashed var(--border);
            border-radius: 32px;
            padding: 40px 20px;
            text-align: center;
            color: var(--sub-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            margin-top: 10px;
            opacity: 0.6;
        }
        
        .empty-icon-svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            fill: currentColor;
        }

        /* 緊湊化：減少 margin */
        .ai-input-container {
            background-color: var(--section-bg);
            border-radius: 32px;
            margin-top: 8px;
            margin-bottom: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: var(--shadow-sm);
        }

        .custom-ai-block {
            width: 100%;
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 0;
            padding: 0;
        }

        .header-small-btn {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 50px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: none;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        .header-small-btn.active {
            background: var(--active-bg);
            color: var(--active-text);
            border-color: transparent;
        }
        .header-small-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        @media (max-width: 600px) {
            .custom-ai-block {
                flex-direction: column;
                align-items: stretch; /* 滿版 */
                gap: 8px;
            }
            .custom-ai-input {
                width: 100%; 
                box-sizing: border-box;
            }
            .custom-btn-group {
                display: flex;
                gap: 8px;
                width: 100%;
            }
            .btn-custom-ai {
                flex: 1; /* 按鈕均分 */
                width: auto;
                margin-left: 0 !important; /* 移除 inline style 的 margin */
            }
        }

        /* 整合後的統一控制面板 (Control Deck) */
        .unified-control-panel {
            background-color: var(--section-bg);
            border-radius: 32px;
            padding: 12px;
            margin-top: 12px;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* 按鈕行，增加間距，不再太緊 */
        .action-row {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .control-group {
            background-color: var(--segment-bg);
            padding: 4px;
            display: flex;
            gap: 0;
            min-height: 36px;
            width: 100%;
            margin-top: 0;
            border-radius: 12px;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }
        
        .dict-arrow {
            transition: transform 0.3s ease;
            display: inline-block;
            margin-left: 6px;
            opacity: 0.6;
            transform: rotate(0deg); /* 預設收起狀態 */
        }
        
        .dict-arrow svg {
            width: 1.3em;
            height: 1.3em;
            vertical-align: middle;
            fill: currentColor;
        }
        
        .dict-arrow.expanded {
            transform: rotate(180deg);
        }

        .icon-svg {
            width: 1.2em;
            height: 1.2em;
            fill: currentColor;
            vertical-align: middle;
        }
        
        .action-icon svg {
            width: 1.4em;
            height: 1.4em;
        }

        .settings-visual svg {
            width: 1.4em;
            height: 1.4em;
            fill: var(--text);
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- 頂部排版優化 -->
        <div class="header-row">
            <h1>
                <svg viewBox="0 0 24 24"><path d="M5 16h14a2 2 0 0 1 2 2v2H3v-2a2 2 0 0 1 2-2zm7-14a5 5 0 0 1 5 5v4H7V7a5 5 0 0 1 5-5z"/></svg> 
                紳士ＡＩ讚美產生器
            </h1>
            <div class="settings-hitbox" onclick="openSettings(event)">
                <div class="settings-visual">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                </div>
            </div>
        </div>

        <!-- 預設辭庫區塊 -->
        <div class="group-section">
            <!-- 第一行：預設辭庫 + 精選按鈕 -->
            <div class="panel-header" onclick="toggleDictionarySection()">
                <span>📂 預設辭庫 <span id="dict-arrow" class="dict-arrow">
                    <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                </span></span>
                <button id="btn-show-featured" class="header-small-btn touch-feedback hidden" onclick="event.stopPropagation(); selectFeaturedCategory(this)">⭐ 精選</button>
            </div>
            
            <!-- 內容區塊，預設隱藏 -->
            <div id="dictionary-content" class="hidden">
                <div class="panel-content">
                    <div id="loading-msg" class="loading">正在讀取資料庫...</div>
                    <div id="main-grid" class="grid-container"></div>
                </div>
                
                <hr class="section-divider">
                
                <!-- 第二行：細部分類標題 + 加入按鈕 -->
                <div class="panel-header sub-header" style="cursor: default;">
                    <span>📍 細部分類</span>
                    <button id="embedded-star-btn" class="header-small-btn disabled touch-feedback">⭐ 加入</button>
                </div>
                <div class="panel-content">
                    <div class="sub-placeholder">請選擇上方分類...</div>
                    <div id="sub-grid" class="grid-container"></div>
                </div>
            </div>
        </div>
        
        <!-- AI 輸入區 -->
        <div class="ai-input-container">
            <div class="custom-ai-block">
                <!-- 修改 placeholder -->
                <input type="text" id="custom-gen-input" class="custom-ai-input" placeholder="✨ 輸入關鍵字句 或 貼上粉絲留言...">
                <div class="custom-btn-group">
                    <button id="btn-custom-gen" class="btn-custom-ai touch-feedback" onclick="handleCustomAiGen()">AI 生成</button>
                    <button id="btn-reply-gen" class="btn-custom-ai touch-feedback" onclick="handleReplyGen()">AI 回覆</button>
                </div>
            </div>
        </div>

        <div class="status-tips-container">
            <div id="status-indicator" class="status-indicator"></div>
            <div class="tips-text-right">💡 點選語句可複製，按鈕可刷新</div>
        </div>

        <div id="result-area" class="result-area" style="margin-top: 0; min-height: auto;"></div>
        
        <!-- 整合後的控制面板：包含換一批與表情選擇 -->
        <div class="unified-control-panel">
            <div class="action-row">
                <div id="regen-btn" class="action-btn btn-regen disabled touch-feedback" onclick="generatePhrases(false, event)">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    換一批
                </div>
                <div id="emoji-reroll-btn" class="action-btn btn-emoji-reroll disabled touch-feedback" onclick="rerollEmojisOnly(event)">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7.5 18c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5S10 14.12 10 15.5 8.88 18 7.5 18zm0-9C6.12 9 5 7.88 5 6.5S6.12 4 7.5 4 10 5.12 10 6.5 8.88 9 7.5 9zm4.5 4.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5S14.5 9.62 14.5 11 13.38 13.5 12 13.5zm4.5 4.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5zm0-9c-1.38 0-2.5-1.12-2.5-2.5S15.12 4 16.5 4 19 5.12 19 6.5 17.88 9 16.5 9z"/></svg>
                    換表符
                </div>
                <div id="ai-batch-btn" class="action-btn btn-ai-batch disabled touch-feedback" onclick="requestBatchAiRewrite(event)">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 9l1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25L19 15z"/></svg>
                    AI 改寫
                </div>
            </div>

            <div class="control-group">
                <div class="control-option active touch-feedback" onclick="setEmojiLevel(3, this)">臉+♡</div>
                <div class="control-option touch-feedback" onclick="setEmojiLevel('kaomoji', this)">顏文字</div>
                <div class="control-option touch-feedback" id="btn-exclamation" onclick="setEmojiLevel(0, this)">驚嘆號</div>
                <div class="control-option touch-feedback" onclick="setEmojiLevel(2, this)">自訂</div>
            </div>
        </div>

        <div class="xp-container" onclick="openXPPopover(event)">
            <div class="xp-info">
                <div class="xp-title"><span id="xp-badge" class="xp-badge">LV.1</span><span id="user-title">見習紳士</span></div>
                <span id="xp-text">0/5 XP</span>
            </div>
            <div class="xp-bar-bg"><div id="xp-bar-fill" class="xp-bar-fill"></div></div>
        </div>

        <div class="search-block">
            <div class="history-group">
                <div class="history-btn touch-feedback" onclick="openHistory('history', event)">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                    歷史紀錄
                </div>
                <div class="history-btn touch-feedback" id="fav-btn-main" onclick="openHistory('fav', event)">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    我的最愛
                </div>
                <div class="history-btn touch-feedback" id="achieve-btn-main" onclick="openAchievements(event)">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M20.2 2H3.8C2.8 2 2 2.8 2 3.8v1.7c0 .8.5 1.5 1.2 1.9l.1.1c.1 3.2 2.5 5.9 5.7 6.4 1.2 1.8 3.3 2.9 5.6 2.9h.8c2.3 0 4.4-1.1 5.6-2.9 3.2-.5 5.6-3.2 5.7-6.4l.1-.1c.7-.4 1.2-1.1 1.2-1.9V3.8c0-1-.8-1.8-1.8-1.8zM5.5 7.1C4.7 6.7 4 6 4 5h1.5v2.1zm13 0V5h1.5c0 1-.7 1.7-1.5 2.1zM11.2 18h1.5l.8 4h-3l.7-4z"/></svg>
                    成就徽章
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="search-input" class="search-input" placeholder="輸入關鍵字 (如: 胸, 腿)">
                <button class="search-btn touch-feedback" onclick="searchPhrases()">搜尋</button>
            </div>
        </div>

        <!-- 整合後的底部控制區 -->
        <div class="footer-control-area">
            <div class="footer-btn-grid">
                <!-- 第一排：連結 -->
                <a href="https://x.com/orz_can" target="_blank" class="footer-action-btn touch-feedback">
                    <svg class="icon-svg" style="width:1.1em;height:1.1em;" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    Twitter
                </a>
                <a href="https://www.paintcanfarm.com/" target="_blank" class="footer-action-btn touch-feedback">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                    Home
                </a>
                
                <!-- 第二排：贊助 -->
                <a href="https://www.paypal.com/paypalme/paintcanfarm" target="_blank" class="footer-action-btn touch-feedback">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M18.5 3H6c-1.1 0-2 .9-2 2v5.71c0 3.83 2.95 7.18 6.78 7.29 3.96.12 7.22-3.06 7.22-7V5c0-1.1-.9-2-2-2zM4 5h2v6H4V5zm14 6c0 2.21-1.79 4-4 4h-2V5h6v6zM2 19h20v2H2v-2z"/></svg>
                    PayPal
                </a>
                <a href="https://orzcan.fanbox.cc/" target="_blank" class="footer-action-btn touch-feedback">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                    Fanbox
                </a>
            </div>
            
            <div class="footer-desc">
                AI 運算與伺服器維護皆需要持續的資金成本。如果您喜歡這項服務，懇請考慮小額贊助，這將成為我持續開發與優化最大的動力。<br>
                Copyright ©2017-2026. 缶子牧場 All Rights Reserved.
            </div>
        </div>
    </div>

    <div id="xp-popover" class="xp-popover">
        <div class="xp-popover-header"><span>📊 紳士等級與獎勵</span><span class="xp-popover-close" onclick="closeXPPopover()">×</span></div>
        <div class="xp-popover-content">
            <div class="xp-list-title" style="margin-top:0;">經驗獲取</div>
            <div class="xp-rule-row"><span>複製句子</span><span class="xp-rule-val">+1 XP</span></div>
            <div class="xp-rule-row"><span>收藏 / 精選</span><span class="xp-rule-val">+3 XP</span></div>
            <div class="xp-list-title">解鎖獎勵</div><div id="xp-unlock-list"></div>
            <div class="xp-list-title">稱號一覽</div><div id="xp-title-list"></div>
        </div>
    </div>

    <div id="toast" class="toast">✅ 已複製內容！</div>
    <div id="levelup-toast" class="toast" style="background-color: var(--primary); font-weight:800;">🎉 升級啦！</div>
    <div id="achieve-toast"><div class="achieve-toast-icon">🏆</div><div class="achieve-toast-title">成就解鎖！</div><div class="achieve-toast-desc">恭喜獲得新徽章</div></div>

    <div id="welcome-modal" onclick="closeWelcomeModal()">
        <div class="welcome-content" style="top: 5% !important;" onclick="event.stopPropagation()">
            <div id="capture-target" class="welcome-card-inner">
                <div class="welcome-header-group"><div class="welcome-header-pill">✨ 今日紳士運勢 ✨</div><div class="modal-date-row"><span id="modal-date">2025/01/01</span></div></div>
                <div class="welcome-body"><div class="welcome-emoji" id="welcome-emoji">🎁</div><div class="welcome-text" id="welcome-text">載入中...</div><div class="welcome-sub" id="welcome-sub">今日紳士指數：⭐⭐⭐</div></div>
            </div>
            <div class="welcome-actions">
                <button class="welcome-btn btn-dl-img touch-feedback" onclick="saveCardAsImage()">📥 存圖</button>
                <button class="welcome-btn btn-copy-txt touch-feedback" onclick="copyWelcomeText()">📋 複製</button>
                <button class="welcome-btn btn-start touch-feedback" onclick="closeWelcomeModal()">🚀 開始</button>
            </div>
        </div>
    </div>

    <div id="achieve-detail-modal" class="achieve-popover-fixed" onclick="closeAchieveDetail()">
        <div class="achieve-detail-card" onclick="event.stopPropagation()">
            <div id="achieve-capture-target" class="welcome-card-inner" style="border-radius: 20px;">
                <div class="welcome-header-group"><div class="welcome-header-pill" style="font-size: 0.75rem; padding: 4px 12px;">🏆 成就解鎖證明</div><div class="modal-date-row"><span id="detail-date">2025/01/01</span></div></div>
                <div class="welcome-body" style="display: flex; flex-direction: column; align-items: center;"><div class="welcome-emoji" id="detail-icon" style="font-size: 3.5rem; margin-bottom: 10px;">🎁</div><div class="welcome-text" id="detail-title" style="font-size: 1.1rem; text-align: center;">成就名稱</div><div class="welcome-sub" id="detail-desc" style="font-size: 0.8rem; opacity: 0.8; text-align: center;">成就敘述...</div></div>
            </div>
            <div class="welcome-actions" style="border-radius: 0 0 20px 20px;">
                <button class="welcome-btn btn-dl-img touch-feedback" onclick="saveAchieveCard()">📥 存圖紀念</button>
                <button class="welcome-btn btn-start touch-feedback" onclick="closeAchieveDetail()">❌ 關閉</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal" onclick="closeHistory(event)">
        <div class="modal-content" id="modal-content-box" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">紀錄與收藏</div><div class="close-x touch-feedback" onclick="closeHistory()">×</div></div>
            <div class="tab-group"><div id="tab-history" class="tab-btn active touch-feedback" style="width:48%;" onclick="switchTab('history')">📜 歷史紀錄</div><div id="tab-fav" class="tab-btn touch-feedback" style="width:48%;" onclick="switchTab('fav')">⭐ 我的最愛</div></div>
            <div id="history-list" class="history-list"></div>
            <div class="modal-footer"><button id="clear-fav-btn" class="clear-btn touch-feedback" onclick="clearFavorites()" style="display:none;">🗑️ 清空所有收藏</button><button class="close-btn-full touch-feedback" onclick="closeHistory()">關閉視窗</button></div>
        </div>
    </div>

    <div id="achieve-modal" class="modal" onclick="closeAchievements(event)">
        <div class="modal-content" id="achieve-content-box" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">🏆 成就徽章</div><div class="close-x touch-feedback" onclick="closeAchievements()">×</div></div>
            <div id="achieve-list" class="history-list" style="gap: 8px;"></div>
            <div class="modal-footer"><button class="close-btn-full touch-feedback" onclick="closeAchievements()">關閉視窗</button></div>
        </div>
    </div>

    <div id="tutorial-modal" class="modal" onclick="closeTutorial(event)">
        <div class="modal-content" id="tutorial-content-box" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">📖 使用教學</div><div class="close-x touch-feedback" onclick="closeTutorial()">×</div></div>
            <div style="flex: 1; overflow-y: auto;">
                <div class="tutorial-content">
                    <div class="tutorial-block">
                        <h3>🚀 1. 快速上手</h3>
                        <p>歡迎來到紳士 AI 讚美產生器！只需三個步驟即可生成：</p>
                        <ul>
                            <li><strong>Step 1：</strong>點擊「📂 預設辭庫」展開分類。</li>
                            <li><strong>Step 2：</strong>在下方選擇情境（細項），系統會立即生成。</li>
                            <li><strong>Step 3：</strong>點擊喜歡的語句即可<strong>自動複製</strong>。</li>
                        </ul>
                    </div>
                    <div class="tutorial-block">
                        <h3>⚡ 2. 進階功能</h3>
                        <ul>
                            <li><strong>🔄 換一批：</strong>不滿意當前結果？點此重新隨機生成。</li>
                            <li><strong>✨ AI 改寫：</strong>覺得語句太單調？讓 AI 幫你潤飾得更生動！（有冷卻時間限制）。</li>
                            <li><strong>🎨 表情切換：</strong>下方按鈕可切換「顏文字」、「驚嘆號」或「臉+愛心」等風格。</li>
                            <li><strong>🔊 語音朗讀：</strong>點擊語句旁的喇叭圖示，聆聽日語發音。</li>
                        </ul>
                    </div>
                    <div class="tutorial-block">
                        <h3>📊 3. 等級與收藏</h3>
                        <p>每次複製或收藏語句都能獲得<strong>經驗值 (XP)</strong>。</p>
                        <ul>
                            <li><strong>升級：</strong>隨著等級提升，你可以解鎖更多<strong>介面主題顏色</strong>（如粉色、黑色、金色等）。</li>
                            <li><strong>收藏：</strong>點擊星星「☆」可將語句加入「我的最愛」，方便日後查看。</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="close-btn-full touch-feedback" onclick="closeTutorial()">我知道了</button></div>
        </div>
    </div>

    <div id="settings-modal" class="modal" onclick="closeSettings(event)">
        <div class="modal-content" id="settings-content-box" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">⚙️ 詳細設定</div><div class="close-x touch-feedback" onclick="closeSettings()">×</div></div>
            <div class="tab-group">
                <div id="tab-general" class="tab-btn active touch-feedback" onclick="switchSettingsTab('general')">🛠️ 一般</div>
                <div id="tab-theme" class="tab-btn touch-feedback" onclick="switchSettingsTab('theme')">🏆 外觀</div>
                <div id="tab-custom" class="tab-btn touch-feedback" onclick="switchSettingsTab('custom')">🎨 自訂</div>
                <div id="tab-faces" class="tab-btn touch-feedback" onclick="switchSettingsTab('faces')">🙂 臉部</div>
                <div id="tab-decor" class="tab-btn touch-feedback" onclick="switchSettingsTab('decor')">✨ 裝飾</div>
                <div id="tab-data" class="tab-btn touch-feedback" onclick="switchSettingsTab('data')">💾 資料</div>
            </div>
            
            <div id="panel-general" style="flex: 1; overflow-y: auto; padding-right: 5px;">
                <div class="help-banner touch-feedback" onclick="openTutorial()"><span>📖</span> 點我看完整使用教學</div>
                <div class="setting-group">
                    <div class="setting-group-header">👀 顯示與外觀</div>
                    <div class="setting-row"><div class="setting-label">深色模式</div><label class="switch"><input type="checkbox" id="toggle-dark" onchange="setDarkMode(this.checked)"><span class="slider"></span></label></div>
                    <div class="setting-row"><div class="setting-label">減少圖像符號模式</div><label class="switch"><input type="checkbox" id="toggle-pure" onchange="togglePureMode(this.checked)"><span class="slider"></span></label></div>
                    <div class="setting-row"><div class="setting-label">隱藏趣味性要素</div><label class="switch"><input type="checkbox" id="toggle-fun" onchange="toggleFunMode(this.checked)"><span class="slider"></span></label></div>
                    <div class="setting-row"><div class="setting-label">字體大小</div><div class="setting-control"><div class="font-btn touch-feedback" id="font-s" onclick="setFontSize(0)">小</div><div class="font-btn touch-feedback" id="font-m" onclick="setFontSize(1)">中</div><div class="font-btn touch-feedback" id="font-l" onclick="setFontSize(2)">大</div></div></div>
                    <div class="setting-row"><div class="setting-label">一次生成數量</div><div class="setting-control"><input type="range" min="1" max="8" value="6" id="count-slider" oninput="updateResultCount(this.value)"><span id="count-display" class="slider-val-display">6</span></div></div>
                    <div class="setting-row"><div class="setting-label">顯示中文翻譯</div><label class="switch"><input type="checkbox" id="toggle-cn" checked onchange="toggleSetting('showCN', this.checked)"><span class="slider"></span></label></div>
                </div>
                <div class="setting-group">
                    <div class="setting-group-header">🗣️ 語音設定 (TTS)</div>
                    <div class="setting-row"><div class="setting-label">顯示發聲按鈕</div><label class="switch"><input type="checkbox" id="toggle-speak" checked onchange="toggleSetting('showSpeak', this.checked)"><span class="slider"></span></label></div>
                    <div class="setting-row"><div class="setting-label">語速 (Speed)</div><div class="setting-control"><input type="range" min="0.5" max="1.5" step="0.1" value="1.1" id="rate-slider" oninput="updateVoiceSetting('rate', this.value)"></div></div>
                    <div class="setting-row"><div class="setting-label">音調 (Pitch)</div><div class="setting-control"><input type="range" min="0.5" max="1.5" step="0.1" value="1.0" id="pitch-slider" oninput="updateVoiceSetting('pitch', this.value)"></div></div>
                    <div class="setting-row" style="justify-content: center;"><button class="font-btn touch-feedback" onclick="testVoice()">
                        <svg class="icon-svg" style="width:1em;height:1em;margin-right:4px;" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg> 試聽語音
                    </button></div>
                </div>
                <a href="https://twitter.com/intent/tweet?text=%E6%88%91%E7%99%BC%E7%8F%BE%E4%BA%86%E4%B8%80%E5%80%8B%E8%B6%85%E5%A5%BD%E7%94%A8%E7%9A%84%E7%B4%B3%E5%A3%AB%E8%AE%9A%E7%BE%8E%E7%94%A2%E7%94%9F%E5%99%A8+%F0%9F%A4%A4%0A%0A%23%E7%B4%B3%E5%A3%AB%E8%AE%9A%E7%BE%8E%E7%94%A2%E7%94%9F%E5%99%A8+%23%E7%B4%B3%E5%A3%AB%E5%BF%85%E5%82%99+%23%E7%BC%B6%E5%AD%90%E7%89%A7%E5%A0%B4&url=https%3A%2F%2Fwww.paintcanfarm.com%2Ftool-praise-generator" target="_blank" class="share-x-btn touch-feedback"><span>🐦 分享此工具到 X</span></a>
            </div>

            <div id="panel-data" style="flex: 1; overflow-y: auto; padding-right: 5px; display:none;">
                <div class="setting-group">
                    <div class="setting-group-header">💾 資料備份與還原</div>
                    <div class="backup-grid">
                        <div class="backup-btn touch-feedback" onclick="exportSettings()"><span class="backup-icon">📤</span><span class="backup-label">匯出檔案</span></div>
                        <div class="backup-btn touch-feedback" onclick="document.getElementById('import-file').click()"><span class="backup-icon">📥</span><span class="backup-label">匯入檔案</span></div>
                        <div class="backup-btn touch-feedback" onclick="exportToClipboard()"><span class="backup-icon">📋</span><span class="backup-label">複製設定碼</span></div>
                        <div class="backup-btn touch-feedback" onclick="importFromClipboard()"><span class="backup-icon">📝</span><span class="backup-label">讀取設定碼</span></div>
                        <input type="file" id="import-file" style="display:none" accept=".json" onchange="importSettings(this)">
                    </div>
                </div>
                <div class="setting-group">
                    <div class="setting-group-header">🗑️ 清除資料</div>
                    <div class="setting-row"><div class="setting-label">清除歷史紀錄</div><button class="clear-btn touch-feedback" style="width:auto; padding:6px 12px;" onclick="clearHistoryLog()">執行</button></div>
                    <div class="setting-row"><div class="setting-label">清除我的最愛</div><button class="clear-btn touch-feedback" style="width:auto; padding:6px 12px;" onclick="clearFavoritesData()">執行</button></div>
                    <div class="setting-row"><div class="setting-label">清除精選細項</div><button class="clear-btn touch-feedback" style="width:auto; padding:6px 12px;" onclick="clearFeaturedData()">執行</button></div>
                    <div class="setting-row" style="justify-content:center; border-bottom:none; padding-top:15px;"><button class="clear-btn touch-feedback" style="width:100%; border:2px solid var(--delete-color); background:rgba(255, 59, 48, 0.05);" onclick="resetAllData()">⚠️ 完全重置所有資料 (含設定)</button></div>
                </div>
            </div>

            <div id="panel-theme" style="flex: 1; overflow-y: auto; padding-right: 5px; display:none;">
                <div class="setting-group">
                    <div class="setting-group-header">🏆 紳士成就與外觀</div>
                    <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                        <div class="setting-label">介面主題</div>
                        <div class="theme-grid" style="width: 100%;">
                            <div class="theme-btn active touch-feedback" id="theme-default" onclick="setTheme('default')">🔵 預設藍</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-pink" onclick="setTheme('pink')">🌸 戀愛粉</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-teal" onclick="setTheme('teal')">🌿 清新綠</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-wine" onclick="setTheme('wine')">🍷 酒紅</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-silver" onclick="setTheme('silver')">🥈 冷冽銀</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-purple" onclick="setTheme('purple')">🔮 夢幻紫</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-gold" onclick="setTheme('gold')">👑 帝王金</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-colorful" onclick="setTheme('colorful')">🌈 色彩繽紛</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-twitter" onclick="setTheme('twitter')">✖️ X 配色</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-orange" onclick="setTheme('orange')">🍊 愛馬仕橘</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-fanbox" onclick="setTheme('fanbox')">📦 Fanbox</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-youtube" onclick="setTheme('youtube')">▶️ Youtube</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-tech" onclick="setTheme('tech')">🤖 科技藍</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-plurk" onclick="setTheme('plurk')">🦴 噗浪</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-melon" onclick="setTheme('melon')">🍈 Melon</div>
                            <div class="theme-btn disabled touch-feedback" id="theme-mono" onclick="setTheme('mono')">🧘 賢者黑白</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="panel-emoji" style="flex: 1; overflow-y: auto; display:none;">
                <div class="emoji-input-group"><input type="text" id="new-emoji-input" class="emoji-input" placeholder="貼上或輸入新表符..."><button class="emoji-add-btn touch-feedback" onclick="addNewEmoji()">新增</button></div>
                <div style="display:flex; justify-content:flex-end; margin-bottom:8px;"><button class="clear-btn touch-feedback" style="width:auto; padding:4px 10px; font-size:0.75rem;" onclick="resetEmojiList()">🔄 恢復預設</button></div>
                <div class="section-title" style="margin-bottom: 8px;">點擊以停用/啟用 (灰色為停用)</div>
                <div id="emoji-grid" class="emoji-grid"></div>
            </div>

            <div id="panel-custom" style="flex: 1; overflow-y: auto; display:none;">
                <div class="section-title" style="margin-top:0;">🎨 自訂表符數量</div>
                <div class="setting-row"><div class="setting-label">最少幾個？</div><div class="setting-control"><input type="range" min="1" max="10" value="3" id="min-custom-slider" oninput="updateCustomMix('min', this.value)"><span id="min-custom-display" class="slider-val-display">3</span></div></div>
                <div class="setting-row"><div class="setting-label">最多幾個？</div><div class="setting-control"><input type="range" min="1" max="10" value="5" id="max-custom-slider" oninput="updateCustomMix('max', this.value)"><span id="max-custom-display" class="slider-val-display">5</span></div></div>
            </div>

            <div class="modal-footer"><button class="close-btn-full touch-feedback" onclick="closeSettings()">關閉設定</button></div>
        </div>
    </div>

    <script>
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSM6yn6wGB_TcdLtSDqQMiaDL3WICybpnSqDXqMn8sQ1XFLjiqdqqQib2bO1x7nAHrWYVK7VSrDU2io/pub?output=csv';
        const KAOMOJI_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSM6yn6wGB_TcdLtSDqQMiaDL3WICybpnSqDXqMn8sQ1XFLjiqdqqQib2bO1x7nAHrWYVK7VSrDU2io/pub?output=csv&gid=1661570307';
        
        const defaultFaces = ["😍", "🥰", "😘", "😚", "😋", "🥵", "😳", "🥺", "😭", "😤", "🙏", "🤤", "😵‍💫", "🫠", "🫦", "🫡", "😇", "🤯", "🫣", "🤭", "🥴", "🤠", "😎"];
        const defaultDecor = ["❤️", "🧡", "💛", "💙", "💜", "🤍", "❣️", "💕", "💞", "💓", "💗", "💖", "💘", "💝", "💟", "❤️‍🔥", "🫶", "✨", "🌟", "💫", "💥", "💢",  "📸", "💎", "🔥", "💦", "🔞", "💋", "👅", "👙", "👠", "🎀", "🥀", "🌹", "🩸", "👃", "🦵", "🍑", "🍼", "🙏", "🙇", "🙌", "👐", "🫶", "👌", "👉", "👆", "👇", "👍", "🛐", "🤝", "💪"];
        const punctuations = ["…", "…！", "…！！", "！", "！！", "！！！"];
        
        let database = {};
        let kaomojiList = [];
        
        const mainGrid = document.getElementById('main-grid'), subGrid = document.getElementById('sub-grid'), resultArea = document.getElementById('result-area'), toast = document.getElementById('toast'), loadingMsg = document.getElementById('loading-msg');
        const regenBtn = document.getElementById('regen-btn');
        const aiBatchBtn = document.getElementById('ai-batch-btn'); 
        const searchInput = document.getElementById('search-input');
        
        let currentMain = null, currentSub = null, emojiLevel = 3, currentDisplayState = [], seenIndices = new Set(), historyLog = [];
        let favorites = [], currentTab = 'history';
        
        window._aiCount = 0;
        window._aiStartTime = 0;
        
        let appSettings = {
            fontSize: 0, resultCount: 6, showCN: true, showSpeak: true, customMin: 3, customMax: 5, voiceRate: 1.1, voicePitch: 1.0, copyAction: 'none',
            userXP: 0, userLevel: 1, userTheme: 'default', hideAd: false, pureMode: false, funMode: true,
            totalCopies: 0
        };
        
        let activeFaces = [], activeDecor = [], disabledFaces = [], disabledDecor = [], savedSubCategories = [], currentSettingsTab = 'general';
        let wixConnectionInterval = null;

        const XP_COPY = 1;
        const XP_FAV = 3; 
        
        const LEVEL_TITLES = { 
            1: "見習紳士", 10: "變態預備軍", 20: "賢者模式", 30: "資深老司機", 40: "紳士鑑賞家", 50: "碩果僅存的紳士", 
            60: "變態的極致", 70: "紳士大師", 80: "變態宗師", 90: "紳士之神", 100: "傳說中的變態", 
            110: "薄本獵人", 120: "聖光破壞者", 130: "絕對領域觀測員", 140: "惡墮鑑賞家", 150: "觸手操控師", 
            160: "異種姦審查官", 170: "時間停止使用者", 180: "催眠洗腦大師", 190: "步兵團總司令", 200: "變態紳士王" 
        };
        const UNLOCKS = { 10: "🌸 戀愛粉主題", 20: "🧘 賢者黑白主題", 30: "🌿 清新綠主題", 40: "🍷 酒紅色主題", 50: "🥈 冷冽銀主題", 60: "🔮 夢幻紫主題", 70: "👑 帝王金主題", 80: "🌈 色彩繽紛主題", 90: "✖️ X 配色主題", 100: "🍊 愛馬仕橘主題", 110: "📦 Fanbox 主題", 120: "▶️ Youtube 主題", 130: "🤖 科技藍主題", 140: "🦴 噗浪主題", 150: "🍈 Melon 主題" };

        const ACHIEVEMENTS = {
            "first_copy": { id: "first_copy", icon: "🌱", title: "初出茅廬", desc: "第一次複製任何句子" },
            "first_fav": { id: "first_fav", icon: "⭐", title: "心動時刻", desc: "第一次將句子加入「我的最愛」" },
            "first_search": { id: "first_search", icon: "🔍", title: "尋寶獵人", desc: "使用過 1 次「搜尋」功能" },
            "read_tutorial": { id: "read_tutorial", icon: "📖", title: "好學生", desc: "完整打開並閱讀過「使用教學」" },
            "download_card": { id: "download_card", icon: "📸", title: "永恆的瞬間", desc: "成功下載一次「今日運勢」圖片" },
            "n1_japanese": { id: "n1_japanese", icon: "🇯🇵", title: "日文N1", desc: "在設定中關閉「顯示中文翻譯」" },
            "copy_50": { id: "copy_50", icon: "🗣️", title: "口若懸河", desc: "累計複製次數達到 50 次" },
            "copy_500": { id: "copy_500", icon: "💘", title: "千言萬語", desc: "累計複製次數達到 500 次" },
            "combo_master": { id: "combo_master", icon: "⚡", title: "連擊大師", desc: "在 10 秒內連續複製 5 次" },
            "fav_full": { id: "fav_full", icon: "💗", title: "博愛主義者", desc: "我的最愛存滿 24 個句子" },
            "fav_del": { id: "fav_del", icon: "💔", title: "斷捨離", desc: "從我的最愛中刪除一個句子" },
            "regen_20": { id: "regen_20", icon: "🔄", title: "換帖兄弟", desc: "連續點擊「換一批」按鈕 20 次" },
            "five_star_general": { id: "five_star_general", icon: "🎖️", title: "五星上將", desc: "在今日運勢中抽到五星金框" },
            "pure_mode": { id: "pure_mode", icon: "🧘", title: "極簡主義", desc: "開啟「減少圖像符號模式」" },
            "voice_lover": { id: "voice_lover", icon: "🔊", title: "聲之形", desc: "點擊 10 次語音播放按鈕" },
            "rap_god": { id: "rap_god", icon: "🎤", title: "快嘴饒舌", desc: "將語音語速調到最快 (1.5) 並按下試聽" },
            "custom_emoji": { id: "custom_emoji", icon: "🙂", title: "表情鍊金術師", desc: "在設定中新增一個「自訂表情符號」" },
            "erotic_fan": { id: "erotic_fan", icon: "🔞", title: "誠實的紳士", desc: "連續生成「🔞 紳士讚美」分類 10 次" },
            "pure_love": { id: "pure_love", icon: "🥰", title: "純愛戰士", desc: "連續生成「🥰 單純可愛」分類 10 次" },
            "kaomoji_fan": { id: "kaomoji_fan", icon: '<span style="color:#EA580C; font-size:0.5em; font-weight:800;">(≧∇≦)</span>', title: "顏文字控", desc: "將表情設定切換為「顏文字」並生成" },
            "color_master": { id: "color_master", icon: "🌈", title: "色彩大師", desc: "更換過 3 種不同的介面主題" },
            "ai_awakening": { id: "ai_awakening", icon: "🤖", title: "機械飛昇", desc: "成功使用 AI 功能進行擴寫" },
            "level_50": { id: "level_50", icon: "🥈", title: "半百紳士", desc: "等級達到 LV.50" },
            "level_100": { id: "level_100", icon: "👑", title: "百級成神", desc: "等級達到 LV.100" },
            "all_complete": { id: "all_complete", icon: "🏆", title: "大滿貫", desc: "解鎖所有其他成就" }
        };

        let userAchieve = {};
        let sessionData = { copyCount: 0, lastCopyTime: 0, comboCount: 0, regenStreak: 0, eroticStreak: 0, cuteStreak: 0, themeCount: new Set(), voiceClickCount: 0 };

        function toggleDictionarySection() {
            const content = document.getElementById('dictionary-content');
            const arrow = document.getElementById('dict-arrow');
            const btnFeatured = document.getElementById('btn-show-featured');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.classList.add('expanded');
                btnFeatured.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
                arrow.classList.remove('expanded');
                btnFeatured.classList.add('hidden');
            }
        }

        function updateStatusUI(type, param = "") {
            const statusIndicator = document.getElementById('status-indicator');
            statusIndicator.classList.remove('pulsing');
            
            if (type === 'idle') {
                statusIndicator.innerHTML = '<span class="status-dot"></span> 請選擇預設辭庫或AI生成';
            } else if (type === 'selected') {
                statusIndicator.innerHTML = `📍 ${param}`;
            } else if (type === 'reply_gen') {
                statusIndicator.innerHTML = '✨ 回覆生成中...';
                statusIndicator.classList.add('pulsing');
            } else if (type === 'keyword_gen') {
                statusIndicator.innerHTML = '✨ 關鍵語句生成中...';
                statusIndicator.classList.add('pulsing');
            } else if (type === 'rewriting') {
                statusIndicator.innerHTML = `✨ ${param} + AI 改寫中...`;
                statusIndicator.classList.add('pulsing');
            } else if (type === 'done_ai') {
                statusIndicator.innerHTML = `✅ AI 生成完成`;
            }
        }

        async function init() {
            initTouchFeedback();
            initDarkMode(); 
            loadHistory(); 
            loadFavorites(); 
            loadSettings(); 
            loadAchievements(); 
            showSkeletonLoading(); 
            applySettingsUI();
            updateXPUI(); 
            
            document.addEventListener('click', function(event) {
                const popover = document.getElementById('xp-popover');
                const xpContainer = document.querySelector('.xp-container');
                if (popover.style.display === 'block' && !popover.contains(event.target) && !xpContainer.contains(event.target)) {
                    closeXPPopover();
                }
            });

            window.onmessage = (event) => {
                const data = event.data;
                if (data.type === 'LOAD_DATA') {
                    if (data.payload) {
                        try {
                            const parsed = (typeof data.payload === 'string') ? JSON.parse(data.payload) : data.payload;
                            if(parsed.appSettings) appSettings = { ...appSettings, ...parsed.appSettings }; 
                            if(parsed.activeFaces) activeFaces = parsed.activeFaces;
                            if(parsed.activeDecor) activeDecor = parsed.activeDecor;
                            if(parsed.disabledFaces) disabledFaces = parsed.disabledFaces;
                            if(parsed.disabledDecor) disabledDecor = parsed.disabledDecor;
                            if(parsed.savedSubCategories) savedSubCategories = parsed.savedSubCategories;
                            if(parsed.favorites) favorites = parsed.favorites;
                            if(parsed.historyLog) historyLog = parsed.historyLog;
                            if(parsed.userAchieve) userAchieve = parsed.userAchieve;

                            if (parsed.currentDisplayState && Array.isArray(parsed.currentDisplayState) && parsed.currentDisplayState.length > 0) {
                                currentDisplayState = parsed.currentDisplayState;
                                renderFromState(false); 
                                showToast("📂 已恢復上次的紀錄");
                            } else {
                                renderFromState(false); // Render empty state
                            }

                            saveAllSettings(); 
                            localStorage.setItem('favorites', JSON.stringify(favorites));
                            localStorage.setItem('historyLog', JSON.stringify(historyLog));
                            localStorage.setItem('userAchieve', JSON.stringify(userAchieve));
                            
                            applySettingsUI();
                            updateXPUI();
                            renderHistoryList();
                            if(currentTab === 'fav') renderHistoryList();
                            
                        } catch(e) { console.error("讀檔錯誤", e); }
                    }
                }
                
                if (data.type === 'BATCH_AI_RESULT') {
                    const { results } = data;
                    resetAiButton(); 
                    updateStatusUI('done_ai');

                    if (results && results.error === 'RATE_LIMIT') {
                        showToast("⏳ 系統忙碌中，請稍後再試");
                        return;
                    }

                    if (results && Array.isArray(results)) {
                        let matchCount = 0;
                        results.forEach((item, index) => {
                            if (currentDisplayState[index]) {
                                const textDiv = document.getElementById(`text-${index}`);
                                const cnDiv = document.getElementById(`cn-${index}`);
                                const speakBtn = document.getElementById(`speak-${index}`);
                                const starBtn = document.getElementById(`star-${index}`);
                                const resultItem = textDiv ? textDiv.closest('.result-item') : null;

                                currentDisplayState[index].base.jp = item.text;
                                if (item.translation) currentDisplayState[index].base.cn = item.translation;

                                const newFullText = item.text + currentDisplayState[index].emoji;

                                if (textDiv) {
                                    textDiv.style.opacity = '0';
                                    if (cnDiv) cnDiv.style.opacity = '0';
                                    setTimeout(() => {
                                        textDiv.innerText = newFullText;
                                        textDiv.style.opacity = '1';
                                        textDiv.classList.remove('text-upgraded');
                                        void textDiv.offsetWidth;
                                        textDiv.classList.add('text-upgraded');
                                        const safeText = newFullText.replace(/'/g, "\\'");
                                        textDiv.setAttribute('onclick', `handleResultClick('${safeText}', event)`);
                                        if (resultItem) {
                                            resultItem.classList.remove('ai-upgraded');
                                            void resultItem.offsetWidth; 
                                            resultItem.classList.add('ai-upgraded');
                                        }
                                    }, 300); 
                                }
                                
                                if (cnDiv && item.translation) {
                                    setTimeout(() => {
                                        cnDiv.innerText = item.translation;
                                        cnDiv.style.opacity = '1';
                                        cnDiv.classList.remove('text-upgraded');
                                        void cnDiv.offsetWidth;
                                        cnDiv.classList.add('text-upgraded');
                                    }, 300);
                                }
                                
                                if (speakBtn) speakBtn.setAttribute('onclick', `speakText('${newFullText.replace(/'/g, "\\'")}')`);
                                if (starBtn) {
                                    starBtn.onclick = function() { toggleFavorite(newFullText, this); };
                                    if (favorites.includes(newFullText)) { starBtn.classList.add('active'); 
                                    // SVG Toggle
                                    starBtn.innerHTML = '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>';
                                    } 
                                    else { starBtn.classList.remove('active'); 
                                    // SVG Toggle
                                    starBtn.innerHTML = '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.01 4.38.38-3.32 2.88 1 4.28L12 15.4z"/></svg>';
                                    }
                                }
                            }
                        });
                        
                        showToast("✨ 全體 AI 擴寫完成！");
                        unlockAchievement("ai_awakening");
                        triggerHaptic(100);
                        syncToWix(); 
                    }
                }
            };

            wixConnectionInterval = setInterval(() => {
                if(currentDisplayState.length === 0 && !currentMain) {
                    window.parent.postMessage({ type: 'REQUEST_LOAD' }, "*");
                } else {
                    clearInterval(wixConnectionInterval);
                }
            }, 2000);

            window.parent.postMessage({ type: 'REQUEST_LOAD' }, "*");

            try {
                await Promise.all([
                    fetchWithRetry(SHEET_CSV_URL, 'mainDB'),
                    fetchWithRetry(KAOMOJI_SHEET_CSV_URL, 'kaomojiDB')
                ]);
            } catch(e) {}
            
            parseMainData(); 
            parseKaomojiData();
            loadingMsg.style.display = 'none'; 
            renderMainCategories();
            
            const defaultMain = "⏫ 反應短句", defaultSub = "🥰 單純可愛";
            
            searchInput.addEventListener("keypress", function(event) { if (event.key === "Enter") searchPhrases(); });
            updateActionButtonsState(); 
            
            setTimeout(() => showWelcomeModal(), 500);
            checkTimeAchievements();
        }

        function syncToWix() {
            const backupData = {
                appSettings, activeFaces, activeDecor, disabledFaces, disabledDecor, savedSubCategories, favorites, historyLog, userAchieve,
                currentDisplayState 
            };
            window.parent.postMessage({ type: 'SAVE_DATA', payload: JSON.stringify(backupData) }, "*");
        }

        function showLockedTooltip(element, message) {
            const tooltip = document.createElement('div');
            tooltip.className = 'locked-tooltip';
            tooltip.textContent = message;
            const rect = element.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2) + 'px';
            tooltip.style.top = (rect.top - 10) + 'px'; 
            document.body.appendChild(tooltip);
            setTimeout(() => { if (tooltip && tooltip.parentNode) tooltip.parentNode.removeChild(tooltip); }, 2000);
        }

        function requestBatchAiRewrite() {
            const aiBtn = document.getElementById('ai-batch-btn');
            if (!aiBtn || aiBtn.classList.contains('disabled')) return;

            const MAX_PER_MINUTE = 3;
            const now = Date.now();

            if (now - window._aiStartTime > 60000) { window._aiCount = 0; window._aiStartTime = now; }
            if (window._aiCount === 0) window._aiStartTime = now;

            if (window._aiCount >= MAX_PER_MINUTE) {
                showLockedTooltip(aiBtn, "一次生成太多嘍，請稍後再試 🥺");
                aiBtn.classList.remove('shake-limit');
                void aiBtn.offsetWidth; 
                aiBtn.classList.add('shake-limit');
                setTimeout(() => aiBtn.classList.remove('shake-limit'), 500);
                return; 
            }
            window._aiCount++;

            aiBtn.classList.add('disabled');
            aiBtn.innerHTML = '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 9l1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25L19 15z"/></svg> 思考中...';
            aiBtn.style.opacity = "0.7";
            triggerHaptic(10);

            const phrasesToRewrite = [];
            if (currentDisplayState && Array.isArray(currentDisplayState)) {
                currentDisplayState.forEach(item => {
                    if (item && item.base && item.base.jp) {
                        phrasesToRewrite.push(item.base.jp);
                    }
                });
            }

            if (phrasesToRewrite.length === 0) {
                showLockedTooltip(aiBtn, "⚠️ 清單是空的");
                resetAiButton();
                return;
            }

            let contextMain = "一般";
            let contextSub = "通用";
            if (currentMain === 'featured_custom') {
                contextMain = "精選收藏";
                contextSub = "我的最愛";
            } else if (database[currentMain]) {
                contextMain = database[currentMain].label;
                if (database[currentMain].subs[currentSub]) {
                    contextSub = database[currentMain].subs[currentSub].label;
                }
            }

            // Disable Refresh
            regenBtn.classList.add('disabled');
            updateStatusUI('rewriting', contextSub);

            window.parent.postMessage({
                type: 'REQUEST_BATCH_AI',
                phrases: phrasesToRewrite,
                context: { main: contextMain, sub: contextSub }
            }, "*");

            setTimeout(() => {
                if (aiBtn.classList.contains('disabled') && aiBtn.textContent.includes('思考中')) {
                    resetAiButton();
                }
            }, 15000);
        }

        function resetAiButton() {
            const aiBtn = document.getElementById('ai-batch-btn');
            if (aiBtn) {
                aiBtn.classList.remove('disabled');
                aiBtn.innerHTML = '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 9l1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25L19 15z"/></svg> AI 改寫';
                aiBtn.style.opacity = "1";
            }
        }

        function sendThemeToWix(isDark) {
            const rootStyles = getComputedStyle(document.documentElement);
            let color = rootStyles.getPropertyValue('--bg').trim();
            if (color.startsWith('var(')) {
                const varName = color.match(/var\(([^)]+)\)/)[1];
                color = rootStyles.getPropertyValue(varName).trim();
            }
            if (!color) color = isDark ? "#000000" : "#F2F2F7";
            window.parent.postMessage({ type: 'CHANGE_BG', color: color }, "*");
        }

        function stripEmojis(str) {
            if (!str) return "";
            return str.replace(/[^\u4E00-\u9FFF\u3040-\u309F\u30A0-\u30FF\uFF00-\uFFEF\u0020-\u007E\u00A0-\u00FF\u3000-\u303F]/g, '').replace(/\s+/g, ' ').trim();
        }

        async function fetchWithRetry(url, storageKey, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const text = await response.text();
                    localStorage.setItem(storageKey, text);
                    return text;
                } catch (err) {
                    if (i === retries - 1) {
                        const cached = localStorage.getItem(storageKey);
                        if (cached) return cached;
                        throw err;
                    }
                    await new Promise(res => setTimeout(res, 1000));
                }
            }
        }

        function parseMainData() {
            const text = localStorage.getItem('mainDB'); if (!text) return;
            const rows = text.split(/\r?\n/).slice(1);
            const cleanStr = (str) => str ? str.trim().replace(/^"|"$/g, '').trim() : '';
            rows.forEach(row => {
                if (!row.trim()) return;
                const cols = row.split(',');
                if (cols.length < 4) return;
                const mainKey = cleanStr(cols[0]), subKey = cleanStr(cols[1]);
                const jpText = stripEmojis(cleanStr(cols[2]));
                const cnText = stripEmojis(cleanStr(cols[3]));
                if (!mainKey || !subKey) return;
                if (!database[mainKey]) database[mainKey] = { label: mainKey, subs: {} };
                if (!database[mainKey].subs[subKey]) database[mainKey].subs[subKey] = { label: subKey, phrases: [] };
                if (jpText) database[mainKey].subs[subKey].phrases.push({ jp: jpText, cn: cnText });
            });
        }

        function parseKaomojiData() {
            const text = localStorage.getItem('kaomojiDB'); if (!text) return;
            const rows = text.split(/\r?\n/).slice(1);
            const cleanStr = (str) => str ? str.trim().replace(/^"|"$/g, '').trim() : '';
            rows.forEach(row => {
                if (!row.trim()) return;
                const cols = row.split(',');
                const kaomoji = cleanStr(cols[0]);
                if (kaomoji) kaomojiList.push(kaomoji);
            });
        }

        function initTouchFeedback() {
            const selector = '.category-btn, .action-btn, .result-item, .control-option, .history-btn, .search-btn, .toggle-btn, .font-btn, .emoji-chip, .emoji-add-btn, .close-x, .tab-btn, .delete-btn, .close-btn-full, .clear-btn, .tutorial-btn-full, .welcome-close-btn, .action-btn-small, .history-item, .extension-toggle, .welcome-btn, .help-banner, .theme-btn, .share-x-btn, .settings-top-btn, .action-icon, .backup-btn, .footer-action-btn';
            document.addEventListener('touchstart', function(e) { const target = e.target.closest(selector); if (target) target.classList.add('pressed'); }, {passive: true});
            const removePressed = () => { document.querySelectorAll('.pressed').forEach(el => setTimeout(() => el.classList.remove('pressed'), 80)); };
            document.addEventListener('touchend', removePressed, {passive: true});
            document.addEventListener('touchcancel', removePressed, {passive: true});
            document.addEventListener('touchmove', removePressed, {passive: true});
        }

        function initDarkMode() {
            const savedTheme = localStorage.getItem('theme');
            const checkbox = document.getElementById('toggle-dark');
            const root = document.documentElement;
            let isDark = false;
            if (savedTheme === null || savedTheme === 'dark') { root.classList.add('dark-mode'); if(checkbox) checkbox.checked = true; isDark = true; }
            else { root.classList.remove('dark-mode'); if(checkbox) checkbox.checked = false; isDark = false; }
            setTimeout(() => sendThemeToWix(isDark), 500);
        }
        
        function setDarkMode(isDark) {
            triggerHaptic(10);
            const root = document.documentElement;
            if (isDark) root.classList.add('dark-mode'); else root.classList.remove('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            syncToWix();
            sendThemeToWix(isDark);
        }
        function triggerHaptic(duration = 10) { if (navigator.vibrate) navigator.vibrate(duration); }
        
        function showWelcomeModal() {
            if (appSettings.hideFun) return;
            const mainKeys = Object.keys(database); if (mainKeys.length === 0) return;
            const randomMain = mainKeys[Math.floor(Math.random() * mainKeys.length)];
            const subKeys = Object.keys(database[randomMain].subs); if (subKeys.length === 0) return;
            const randomSub = subKeys[Math.floor(Math.random() * subKeys.length)];
            const phrases = database[randomMain].subs[randomSub].phrases; if (phrases.length === 0) return;
            const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
            const randomEmoji = defaultFaces[Math.floor(Math.random() * defaultFaces.length)];
            const now = new Date();
            document.getElementById('modal-date').textContent = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')}`;
            document.getElementById('welcome-emoji').textContent = randomEmoji;
            document.getElementById('welcome-text').textContent = randomPhrase.jp + "！"; 
            const rand = Math.random();
            let stars = 3; let frameClass = "";
            if (rand < 0.2) { stars = 5; frameClass = "gold-frame"; unlockAchievement("five_star_general"); } else if (rand < 0.4) { stars = 4; frameClass = "silver-frame"; } else { stars = Math.floor(Math.random() * 3) + 1; }
            let starStr = ""; for(let i=0; i<stars; i++) starStr += "⭐";
            document.getElementById('welcome-sub').textContent = `今日紳士指數：${starStr}`;
            const cardInner = document.getElementById('capture-target');
            cardInner.classList.remove('gold-frame', 'silver-frame');
            if(frameClass) cardInner.classList.add(frameClass);
            document.getElementById('welcome-modal').style.display = 'block';
        }
        function closeWelcomeModal() { triggerHaptic(10); document.getElementById('welcome-modal').style.display = 'none'; }
        function copyWelcomeText() { const text = document.getElementById('welcome-text').textContent; copyToClipboard(text); }
        function saveCardAsImage() {
            triggerHaptic(10); const element = document.getElementById('capture-target');
            html2canvas(element, { backgroundColor: null, scale: 2 }).then(canvas => {
                const link = document.createElement('a'); link.download = `gentleman_card_${Date.now()}.jpg`; link.href = canvas.toDataURL('image/jpeg', 0.9); link.click();
                showToast("📸 圖片已儲存！"); unlockAchievement("download_card");
            });
        }

        function loadSettings() {
            const savedAppSettings = localStorage.getItem('appSettings');
            if (savedAppSettings) { try { appSettings = { ...appSettings, ...JSON.parse(savedAppSettings) }; } catch(e) {} }
            if (typeof appSettings.customMin === 'undefined') appSettings.customMin = 3;
            if (typeof appSettings.customMax === 'undefined') appSettings.customMax = 5;
            if (typeof appSettings.voiceRate === 'undefined') appSettings.voiceRate = 1.1;
            if (typeof appSettings.voicePitch === 'undefined') appSettings.voicePitch = 1.0;
            if (typeof appSettings.userXP === 'undefined') appSettings.userXP = 0;
            if (typeof appSettings.userLevel === 'undefined') appSettings.userLevel = 1;
            if (typeof appSettings.userTheme === 'undefined') appSettings.userTheme = 'default';
            if (typeof appSettings.resultCount === 'undefined') appSettings.resultCount = 6; 
            if (appSettings.resultCount > 8) appSettings.resultCount = 8; 
            const savedFaces = localStorage.getItem('customFaces'); const savedDecor = localStorage.getItem('customDecor');
            const savedDisabledFaces = localStorage.getItem('disabledFaces'); const savedDisabledDecor = localStorage.getItem('disabledDecor');
            activeFaces = savedFaces ? JSON.parse(savedFaces) : [...defaultFaces];
            activeDecor = savedDecor ? JSON.parse(savedDecor) : [...defaultDecor];
            disabledFaces = savedDisabledFaces ? JSON.parse(savedDisabledFaces) : [];
            disabledDecor = savedDisabledDecor ? JSON.parse(savedDisabledDecor) : [];
            const savedSubs = localStorage.getItem('savedSubCategories');
            savedSubCategories = savedSubs ? JSON.parse(savedSubs) : [];
        }

        function saveAllSettings() {
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
            localStorage.setItem('customFaces', JSON.stringify(activeFaces));
            localStorage.setItem('customDecor', JSON.stringify(activeDecor));
            localStorage.setItem('disabledFaces', JSON.stringify(disabledFaces));
            localStorage.setItem('disabledDecor', JSON.stringify(disabledDecor));
            localStorage.setItem('savedSubCategories', JSON.stringify(savedSubCategories));
            localStorage.setItem('userAchieve', JSON.stringify(userAchieve));
            syncToWix();
        }

        function applySettingsUI() {
            setFontSize(appSettings.fontSize, false);
            document.getElementById('count-slider').value = appSettings.resultCount; document.getElementById('count-display').textContent = appSettings.resultCount;
            document.getElementById('min-custom-slider').value = appSettings.customMin; document.getElementById('min-custom-display').textContent = appSettings.customMin;
            document.getElementById('max-custom-slider').value = appSettings.customMax; document.getElementById('max-custom-display').textContent = appSettings.customMax;
            document.getElementById('rate-slider').value = appSettings.voiceRate; document.getElementById('pitch-slider').value = appSettings.voicePitch;
            document.getElementById('toggle-cn').checked = appSettings.showCN; document.getElementById('toggle-speak').checked = appSettings.showSpeak;
            toggleSetting('showCN', appSettings.showCN, false); toggleSetting('showSpeak', appSettings.showSpeak, false);
            setTheme(appSettings.userTheme, false); togglePureMode(appSettings.pureMode, false); toggleFunMode(appSettings.hideFun, false);
            document.getElementById('toggle-pure').checked = appSettings.pureMode; document.getElementById('toggle-fun').checked = appSettings.hideFun;
        }
        
        function loadAchievements() { const saved = localStorage.getItem('userAchieve'); if (saved) { try { userAchieve = JSON.parse(saved); } catch(e) { userAchieve = {}; } } }
        function unlockAchievement(id) {
            if (appSettings.hideFun) return; 
            if (!ACHIEVEMENTS[id]) return;
            if (userAchieve[id] && userAchieve[id].unlocked) return;
            userAchieve[id] = { unlocked: true, date: Date.now() };
            saveAllSettings();
            const toast = document.getElementById('achieve-toast');
            toast.querySelector('.achieve-toast-icon').innerHTML = ACHIEVEMENTS[id].icon; 
            toast.querySelector('.achieve-toast-title').textContent = "成就解鎖！";
            toast.querySelector('.achieve-toast-desc').textContent = ACHIEVEMENTS[id].title;
            toast.classList.add('show'); triggerHaptic(200); setTimeout(() => { toast.classList.remove('show'); }, 3000);
            checkAllComplete();
        }
        function checkAllComplete() {
            if (userAchieve["all_complete"] && userAchieve["all_complete"].unlocked) return;
            const allKeys = Object.keys(ACHIEVEMENTS).filter(k => k !== "all_complete");
            const unlockedCount = allKeys.filter(k => userAchieve[k] && userAchieve[k].unlocked).length;
            if (unlockedCount === allKeys.length) { setTimeout(() => { unlockAchievement("all_complete"); }, 4000); }
        }
        function checkTimeAchievements() { /* Deleted */ }

        function openAchievements(event) {
            triggerHaptic(10); const modal = document.getElementById('achieve-modal'); const content = document.getElementById('achieve-content-box'); const list = document.getElementById('achieve-list'); list.innerHTML = '';
            const allKeys = Object.keys(ACHIEVEMENTS);
            const unlockedKeys = allKeys.filter(k => userAchieve[k] && userAchieve[k].unlocked).sort((a,b) => userAchieve[b].date - userAchieve[a].date);
            const lockedKeys = allKeys.filter(k => !userAchieve[k] || !userAchieve[k].unlocked);
            const renderItem = (key) => {
                const def = ACHIEVEMENTS[key]; const isUnlocked = userAchieve[key] && userAchieve[key].unlocked;
                const div = document.createElement('div'); div.className = `achieve-item ${isUnlocked ? 'unlocked' : ''}`;
                if (isUnlocked) { div.style.cursor = "pointer"; div.onclick = (e) => showAchieveDetail(key, e); }
                let dateStr = ""; if (isUnlocked) { const d = new Date(userAchieve[key].date); dateStr = `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`; }
                div.innerHTML = `<div class="achieve-icon">${isUnlocked ? def.icon : '🔒'}</div><div class="achieve-content"><div class="achieve-title"><span>${def.title}</span>${isUnlocked ? `<span class="achieve-date">${dateStr}</span>` : ''}</div><div class="achieve-desc">${def.desc}</div></div>`;
                list.appendChild(div);
            };
            unlockedKeys.forEach(renderItem); lockedKeys.forEach(renderItem);
            modal.style.display = 'block'; content.style.top = '80px';
        }
        function closeAchievements(event) { if (event && event.target.id !== 'achieve-modal' && event.target.className !== 'close-btn-full' && event.target.className !== 'close-x') return; document.getElementById('achieve-modal').style.display = 'none'; }

        function getXPForLevel(level) { if (level >= 200) return 50; if (level >= 100) return 20; return 5; }
        function addXP(amount) {
            if (appSettings.hideFun) return; 
            appSettings.userXP += amount;
            let level = 1; let xp = appSettings.userXP;
            while (true) { let needed = getXPForLevel(level); if (xp >= needed) { xp -= needed; level++; } else { break; } }
            if (level > appSettings.userLevel) { appSettings.userLevel = level; showLevelUpToast(level); checkUnlocks(level); if (level >= 50) unlockAchievement("level_50"); if (level >= 100) unlockAchievement("level_100"); }
            updateXPUI(); saveAllSettings();
        }
        function updateXPUI() {
            let level = 1; let xp = appSettings.userXP;
            while (true) { let needed = getXPForLevel(level); if (xp >= needed) { xp -= needed; level++; } else { break; } }
            const currentLevelXP = xp; const xpNeeded = getXPForLevel(level); const progressPercent = (currentLevelXP / xpNeeded) * 100;
            document.getElementById('xp-badge').textContent = `LV.${level}`; document.getElementById('xp-text').textContent = `${currentLevelXP}/${xpNeeded} XP`; document.getElementById('xp-bar-fill').style.width = `${progressPercent}%`;
            let title = LEVEL_TITLES[1]; const levels = Object.keys(LEVEL_TITLES).map(Number).sort((a,b) => b-a);
            for (let lvl of levels) { if (level >= lvl) { title = LEVEL_TITLES[lvl]; break; } }
            document.getElementById('user-title').textContent = title; updateUnlockUI(level);
        }
        function showLevelUpToast(level) { if (appSettings.hideFun) return; const toast = document.getElementById('levelup-toast'); toast.textContent = `🎉 升級啦！LV.${level}`; toast.className = "toast show"; setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2000); triggerHaptic(100); }
        
        function openXPPopover(event) {
            triggerHaptic(10); 
            const popover = document.getElementById('xp-popover'); 
            const titleList = document.getElementById('xp-title-list'); titleList.innerHTML = '';
            Object.keys(LEVEL_TITLES).map(Number).sort((a,b) => a-b).forEach(lvl => { const div = document.createElement('div'); div.className = 'xp-list-item ' + (appSettings.userLevel >= lvl ? 'unlocked' : 'locked'); div.innerHTML = `<span>LV.${lvl}</span><span>${LEVEL_TITLES[lvl]}</span>`; titleList.appendChild(div); });
            const unlockList = document.getElementById('xp-unlock-list'); unlockList.innerHTML = '';
            Object.keys(UNLOCKS).map(Number).sort((a,b) => a-b).forEach(lvl => { const div = document.createElement('div'); div.className = 'xp-list-item ' + (appSettings.userLevel >= lvl ? 'unlocked' : 'locked'); div.innerHTML = `<span>LV.${lvl}</span><span>${UNLOCKS[lvl]}</span>`; unlockList.appendChild(div); });
            
            popover.style.display = 'block'; 
        }
        
        function closeXPPopover() { document.getElementById('xp-popover').style.display = 'none'; }
        function checkUnlocks(level) { if (appSettings.hideFun) return; let msg = ""; if (level === 20) msg = "✨ 解鎖 🧘 賢者黑白主題！"; if (level === 100) msg = "🔓 解鎖主題：🍊 愛馬仕橘！"; if (msg) { setTimeout(() => { alert(`恭喜升級到 LV.${level}！\n${msg}\n請到設定頁面查看。`); }, 500); } }
        function updateUnlockUI(level) {
            const pinkBtn = document.getElementById('theme-pink'); const monoBtn = document.getElementById('theme-mono'); const tealBtn = document.getElementById('theme-teal'); const wineBtn = document.getElementById('theme-wine'); const silverBtn = document.getElementById('theme-silver'); const purpleBtn = document.getElementById('theme-purple'); const goldBtn = document.getElementById('theme-gold'); const colorfulBtn = document.getElementById('theme-colorful'); const twitterBtn = document.getElementById('theme-twitter'); const fanboxBtn = document.getElementById('theme-fanbox'); const youtubeBtn = document.getElementById('theme-youtube'); const techBtn = document.getElementById('theme-tech'); const plurkBtn = document.getElementById('theme-plurk'); const melonBtn = document.getElementById('theme-melon');
            const orangeBtn = document.getElementById('theme-orange');

            if (level >= 10) pinkBtn.classList.remove('disabled'); else pinkBtn.classList.add('disabled');
            if (level >= 20) monoBtn.classList.remove('disabled'); else monoBtn.classList.add('disabled');
            if (level >= 30) tealBtn.classList.remove('disabled'); else tealBtn.classList.add('disabled');
            if (level >= 40) wineBtn.classList.remove('disabled'); else wineBtn.classList.add('disabled');
            if (level >= 50) silverBtn.classList.remove('disabled'); else silverBtn.classList.add('disabled');
            if (level >= 60) purpleBtn.classList.remove('disabled'); else purpleBtn.classList.add('disabled');
            if (level >= 70) goldBtn.classList.remove('disabled'); else goldBtn.classList.add('disabled');
            if (level >= 80) colorfulBtn.classList.remove('disabled'); else colorfulBtn.classList.add('disabled');
            if (level >= 90) twitterBtn.classList.remove('disabled'); else twitterBtn.classList.add('disabled');
            if (level >= 100) orangeBtn.classList.remove('disabled'); else orangeBtn.classList.add('disabled');
            if (level >= 110) fanboxBtn.classList.remove('disabled'); else fanboxBtn.classList.add('disabled');
            if (level >= 120) youtubeBtn.classList.remove('disabled'); else youtubeBtn.classList.add('disabled');
            if (level >= 130) techBtn.classList.remove('disabled'); else techBtn.classList.add('disabled');
            if (level >= 140) plurkBtn.classList.remove('disabled'); else plurkBtn.classList.add('disabled');
            if (level >= 150) melonBtn.classList.remove('disabled'); else melonBtn.classList.add('disabled');
        }

        function setTheme(themeName, save = true) {
            if (themeName === 'pink' && appSettings.userLevel < 10) { showToast("🔒 需達到 LV.10 解鎖！"); return; }
            if (themeName === 'mono' && appSettings.userLevel < 20) { showToast("🔒 需達到 LV.20 解鎖！"); return; }
            if (themeName === 'teal' && appSettings.userLevel < 30) { showToast("🔒 需達到 LV.30 解鎖！"); return; }
            if (themeName === 'wine' && appSettings.userLevel < 40) { showToast("🔒 需達到 LV.40 解鎖！"); return; }
            if (themeName === 'silver' && appSettings.userLevel < 50) { showToast("🔒 需達到 LV.50 解鎖！"); return; }
            if (themeName === 'purple' && appSettings.userLevel < 60) { showToast("🔒 需達到 LV.60 解鎖！"); return; }
            if (themeName === 'gold' && appSettings.userLevel < 70) { showToast("🔒 需達到 LV.70 解鎖！"); return; }
            if (themeName === 'colorful' && appSettings.userLevel < 80) { showToast("🔒 需達到 LV.80 解鎖！"); return; }
            if (themeName === 'twitter' && appSettings.userLevel < 90) { showToast("🔒 需達到 LV.90 解鎖！"); return; }
            if (themeName === 'orange' && appSettings.userLevel < 100) { showToast("🔒 需達到 LV.100 解鎖！"); return; }
            if (themeName === 'fanbox' && appSettings.userLevel < 110) { showToast("🔒 需達到 LV.110 解鎖！"); return; }
            if (themeName === 'youtube' && appSettings.userLevel < 120) { showToast("🔒 需達到 LV.120 解鎖！"); return; }
            if (themeName === 'tech' && appSettings.userLevel < 130) { showToast("🔒 需達到 LV.130 解鎖！"); return; }
            if (themeName === 'plurk' && appSettings.userLevel < 140) { showToast("🔒 需達到 LV.140 解鎖！"); return; }
            if (themeName === 'melon' && appSettings.userLevel < 150) { showToast("🔒 需達到 LV.150 解鎖！"); return; }
            
            document.documentElement.classList.remove('theme-pink', 'theme-gold', 'theme-mono', 'theme-teal', 'theme-silver', 'theme-purple', 'theme-wine', 'theme-colorful', 'theme-twitter', 'theme-fanbox', 'theme-youtube', 'theme-tech', 'theme-plurk', 'theme-melon', 'theme-orange');
            if (themeName !== 'default') document.documentElement.classList.add(`theme-${themeName}`);
            appSettings.userTheme = themeName;
            document.querySelectorAll('.theme-btn').forEach(b => { b.classList.remove('active'); if(b.id === `theme-${themeName}`) b.classList.add('active'); });
            if (sessionData.themeCount.size === undefined) sessionData.themeCount = new Set(); sessionData.themeCount.add(themeName); if (sessionData.themeCount.size >= 3) unlockAchievement("color_master");
            if (save) { triggerHaptic(10); saveAllSettings(); }
            const isDark = document.documentElement.classList.contains('dark-mode'); sendThemeToWix(isDark);
        }

        function togglePureMode(enable, save = true) {
            appSettings.pureMode = enable;
            if (enable) { document.body.classList.add('pure-mode'); unlockAchievement("pure_mode"); } else { document.body.classList.remove('pure-mode'); }
            if (database && Object.keys(database).length > 0) {
                renderMainCategories();
                if (currentMain && currentSub) {
                    if (currentMain === 'featured_custom') renderFeaturedSubGrid();
                    else {
                        subGrid.innerHTML = ''; 
                        const subData = database[currentMain].subs;
                        for (const subKey in subData) {
                            const btn = document.createElement('div'); btn.className = 'category-btn'; btn.dataset.key = subKey;
                            if (currentSub === subKey) btn.classList.add('active');
                            let label = subData[subKey].label; if (enable) label = stripEmojis(label); btn.textContent = label;
                            btn.onclick = (e) => { triggerHaptic(10); createParticles(e.clientX, e.clientY); selectSubCategory(subKey, btn); };
                            subGrid.appendChild(btn);
                        }
                    }
                }
            }
            if (save) { triggerHaptic(10); saveAllSettings(); }
        }

        function toggleFunMode(hide, save = true) {
            appSettings.hideFun = hide;
            if (hide) document.body.classList.add('hide-fun'); else document.body.classList.remove('hide-fun');
            if (save) { triggerHaptic(10); saveAllSettings(); }
        }
        
        function exportSettings() {
            triggerHaptic(10); const data = { appSettings, activeFaces, activeDecor, disabledFaces, disabledDecor, savedSubCategories, favorites, userAchieve };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "gentleman_settings.json"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function importSettings(input) {
            const file = input.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = function(e) { try { const data = JSON.parse(e.target.result); applyImportData(data); } catch(err) { alert("❌ 匯入失敗：檔案格式錯誤"); } };
            reader.readAsText(file);
        }
        function exportToClipboard() {
            triggerHaptic(10); const data = { appSettings, activeFaces, activeDecor, disabledFaces, disabledDecor, savedSubCategories, favorites, userAchieve }; const jsonStr = JSON.stringify(data);
            if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(jsonStr).then(() => { alert("✅ 設定碼已複製到剪貼簿！"); }).catch(err => { prompt("複製失敗，請手動複製以下代碼：", jsonStr); }); } else { prompt("請手動複製以下代碼：", jsonStr); }
        }
        function importFromClipboard() {
            triggerHaptic(10);
            if (navigator.clipboard && navigator.clipboard.readText) { navigator.clipboard.readText().then(text => { if (!text) { manualImport(); return; } try { const data = JSON.parse(text); if (!data.appSettings && !data.favorites) throw new Error("Invalid format"); if(confirm("偵測到剪貼簿有設定資料，確定要覆蓋目前的設定嗎？")) { applyImportData(data); } } catch (err) { manualImport(); } }).catch(err => { manualImport(); }); } else { manualImport(); }
        }
        function manualImport() { const text = prompt("請貼上設定碼："); if (text) { try { const data = JSON.parse(text); applyImportData(data); } catch (err) { alert("❌ 格式錯誤：這不是有效的設定碼。"); } } }
        function applyImportData(data) {
            if(data.appSettings) appSettings = data.appSettings; if(data.activeFaces) activeFaces = data.activeFaces; if(data.activeDecor) activeDecor = data.activeDecor; if(data.disabledFaces) disabledFaces = data.disabledFaces; if(data.disabledDecor) disabledDecor = data.disabledDecor; if(data.savedSubCategories) savedSubCategories = data.savedSubCategories; if(data.favorites) favorites = data.favorites; if(data.userAchieve) userAchieve = data.userAchieve;
            saveAllSettings(); localStorage.setItem('favorites', JSON.stringify(favorites)); alert("✅ 設定匯入成功！頁面將重新整理。"); location.reload();
        }

        function openSettings(event) {
            triggerHaptic(10); document.getElementById('history-modal').style.display = 'none'; const modal = document.getElementById('settings-modal'); const content = document.getElementById('settings-content-box'); const hitbox = document.querySelector('.settings-hitbox'); hitbox.classList.remove('active'); void hitbox.offsetWidth; hitbox.classList.add('active');
            setTimeout(() => { modal.style.display = 'block'; if (event) { let topPos = event.clientY; if (topPos > window.innerHeight * 0.6) topPos = window.innerHeight * 0.4; content.style.top = topPos + 'px'; } else { content.style.top = '20%'; } switchSettingsTab('general'); hitbox.classList.remove('active'); }, 150);
        }
        function closeSettings(event) { if (event && event.target.id !== 'settings-modal') return; document.getElementById('settings-modal').style.display = 'none'; }
        function switchSettingsTab(tab) {
            currentSettingsTab = tab; document.querySelectorAll('#settings-modal .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('panel-general').style.display = 'none'; document.getElementById('panel-theme').style.display = 'none'; document.getElementById('panel-emoji').style.display = 'none'; document.getElementById('panel-custom').style.display = 'none'; document.getElementById('panel-data').style.display = 'none';
            if (tab === 'general') { document.getElementById('tab-general').classList.add('active'); document.getElementById('panel-general').style.display = 'block'; } 
            else if (tab === 'theme') { document.getElementById('tab-theme').classList.add('active'); document.getElementById('panel-theme').style.display = 'block'; }
            else if (tab === 'custom') { document.getElementById('tab-custom').classList.add('active'); document.getElementById('panel-custom').style.display = 'block'; } 
            else if (tab === 'data') { document.getElementById('tab-data').classList.add('active'); document.getElementById('panel-data').style.display = 'block'; }
            else { document.getElementById('tab-' + tab).classList.add('active'); document.getElementById('panel-emoji').style.display = 'block'; renderEmojiGrid(); }
        }
        function openTutorial() { triggerHaptic(10); document.getElementById('settings-modal').style.display = 'none'; const modal = document.getElementById('tutorial-modal'); const content = document.getElementById('tutorial-content-box'); modal.style.display = 'block'; content.style.top = '10%'; unlockAchievement("read_tutorial"); }
        function closeTutorial(event) { if (event && event.target.id !== 'tutorial-modal' && event.target.className !== 'close-btn-full' && event.target.className !== 'close-x') return; document.getElementById('tutorial-modal').style.display = 'none'; document.getElementById('settings-modal').style.display = 'block'; }

        function setFontSize(size, save = true) {
            if (save) triggerHaptic(10); appSettings.fontSize = size;
            document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
            if(size === 0) document.getElementById('font-s').classList.add('active'); if(size === 1) document.getElementById('font-m').classList.add('active'); if(size === 2) document.getElementById('font-l').classList.add('active');
            const root = document.documentElement;
            if (size === 0) { root.style.setProperty('--fs-jp', '0.8rem'); root.style.setProperty('--fs-cn', '0.75rem'); }
            else if (size === 1) { root.style.setProperty('--fs-jp', '0.9rem'); root.style.setProperty('--fs-cn', '0.8rem'); }
            else { root.style.setProperty('--fs-jp', '1.1rem'); root.style.setProperty('--fs-cn', '0.95rem'); }
            if (save) saveAllSettings();
        }
        function updateResultCount(val) { appSettings.resultCount = parseInt(val); document.getElementById('count-display').textContent = val; saveAllSettings(); }
        function updateCustomMix(type, val) {
            val = parseInt(val);
            if (type === 'min') { if (val > appSettings.customMax) { val = appSettings.customMax; document.getElementById('min-custom-slider').value = val; } appSettings.customMin = val; document.getElementById('min-custom-display').textContent = val; } 
            else { if (val < appSettings.customMin) { val = appSettings.customMin; document.getElementById('max-custom-slider').value = val; } appSettings.customMax = val; document.getElementById('max-custom-display').textContent = val; }
            saveAllSettings();
        }
        function toggleSetting(key, value, save = true) {
            appSettings[key] = value;
            if (key === 'showCN') { if (value) document.body.classList.remove('hide-cn'); else { document.body.classList.add('hide-cn'); unlockAchievement("n1_japanese"); } }
            if (key === 'showSpeak') { if (value) document.body.classList.remove('hide-speak'); else document.body.classList.add('hide-speak'); }
            if (save) saveAllSettings();
        }
        function updateVoiceSetting(key, val) { if (key === 'rate') appSettings.voiceRate = parseFloat(val); if (key === 'pitch') appSettings.voicePitch = parseFloat(val); saveAllSettings(); }
        function testVoice() { 
            const utterance = new SpeechSynthesisUtterance("大好き"); utterance.lang = 'ja-JP'; utterance.rate = appSettings.voiceRate; utterance.pitch = appSettings.voicePitch; window.speechSynthesis.cancel(); window.speechSynthesis.speak(utterance); 
            sessionData.voiceClickCount++; if (sessionData.voiceClickCount >= 10) unlockAchievement("voice_lover"); if (appSettings.voiceRate >= 1.5) unlockAchievement("rap_god");
        }
        
        function clearHistoryLog() { if(confirm("確定要清空歷史紀錄嗎？")) { triggerHaptic(10); historyLog = []; localStorage.setItem('historyLog', JSON.stringify(historyLog)); syncToWix(); showToast("🗑️ 歷史紀錄已清空"); } }
        function clearFavoritesData() { if(confirm("確定要清空所有收藏嗎？")) { triggerHaptic(10); favorites = []; localStorage.setItem('favorites', JSON.stringify(favorites)); syncToWix(); if(currentDisplayState.length > 0) renderFromState(false); showToast("🗑️ 收藏已清空"); } }
        function clearFeaturedData() { if(confirm("確定要移除所有精選細項嗎？")) { triggerHaptic(10); savedSubCategories = []; saveAllSettings(); if(currentMain === 'featured_custom') { renderFeaturedSubGrid(); } updateEmbeddedStarState(); showToast("💔 精選細項已清空"); } }
        function resetAllData() { if(confirm("確定要清除所有資料嗎？\n這將重置所有設定、收藏與自訂表符。")) { triggerHaptic(10); setTimeout(() => { localStorage.clear(); location.reload(); }, 1000); } }

        function renderEmojiGrid() {
            const grid = document.getElementById('emoji-grid'); grid.innerHTML = '';
            const activeList = currentSettingsTab === 'faces' ? activeFaces : activeDecor; const disabledList = currentSettingsTab === 'faces' ? disabledFaces : disabledDecor;
            activeList.forEach(emoji => { const chip = document.createElement('div'); chip.className = 'emoji-chip'; chip.textContent = emoji; chip.onclick = () => toggleEmojiStatus(emoji, true); grid.appendChild(chip); });
            disabledList.forEach(emoji => { const chip = document.createElement('div'); chip.className = 'emoji-chip disabled'; chip.textContent = emoji; chip.onclick = () => toggleEmojiStatus(emoji, false); grid.appendChild(chip); });
        }
        function toggleEmojiStatus(emoji, isActive) {
            triggerHaptic(10);
            if (currentSettingsTab === 'faces') { if (isActive) { activeFaces = activeFaces.filter(e => e !== emoji); if (!disabledFaces.includes(emoji)) disabledFaces.push(emoji); } else { disabledFaces = disabledFaces.filter(e => e !== emoji); if (!activeFaces.includes(emoji)) activeFaces.push(emoji); } } 
            else { if (isActive) { activeDecor = activeDecor.filter(e => e !== emoji); if (!disabledDecor.includes(emoji)) disabledDecor.push(emoji); } else { disabledDecor = disabledDecor.filter(e => e !== emoji); if (!activeDecor.includes(emoji)) activeDecor.push(emoji); } }
            saveAllSettings(); renderEmojiGrid();
        }
        function addNewEmoji() {
            const input = document.getElementById('new-emoji-input'); const val = input.value.trim(); if (!val) return; triggerHaptic(10);
            if (currentSettingsTab === 'faces') { if (!activeFaces.includes(val) && !disabledFaces.includes(val)) activeFaces.push(val); } else { if (!activeDecor.includes(val) && !disabledDecor.includes(val)) activeDecor.push(val); }
            input.value = ''; saveAllSettings(); renderEmojiGrid(); unlockAchievement("custom_emoji");
        }
        function resetEmojiList() { if(confirm("確定要恢復預設的表情符號列表嗎？")) { triggerHaptic(10); if (currentSettingsTab === 'faces') { activeFaces = [...defaultFaces]; disabledFaces = []; } else { activeDecor = [...defaultDecor]; disabledDecor = []; } saveAllSettings(); renderEmojiGrid(); showToast("🔄 已恢復預設列表"); } }

        function updateEmbeddedStarState() {
            const btn = document.getElementById('embedded-star-btn'); 
            if (!btn) return;
            
            if (currentMain === 'featured_custom') {
                if (savedSubCategories.length === 0) { 
                    btn.classList.add('disabled'); 
                    btn.textContent = '⭐ 加入';
                } else { 
                    btn.textContent = '💔 移除'; 
                    btn.classList.remove('disabled'); 
                    btn.onclick = () => removeCurrentFromFeatured(); 
                } 
                return; 
            }
            
            if (!currentMain || !currentSub) { 
                btn.classList.add('disabled'); 
                btn.textContent = '⭐ 加入'; 
                btn.onclick = null; 
            } else { 
                btn.classList.remove('disabled'); 
                const exists = savedSubCategories.some(item => item.main === currentMain && item.sub === currentSub);
                if (exists) { 
                    btn.textContent = '💔 移除'; 
                    btn.classList.add('active');
                    btn.onclick = () => toggleSavedSubCategory(); 
                } else { 
                    btn.textContent = '⭐ 加入'; 
                    btn.classList.remove('active');
                    btn.onclick = () => toggleSavedSubCategory(); 
                }
            }
        }

        function removeCurrentFromFeatured() {
             if (currentMain !== 'featured_custom' || !currentSub) return; const itemIndex = savedSubCategories.findIndex(item => item.sub === currentSub); if (itemIndex === -1) return; const originalMain = savedSubCategories[itemIndex].main; const originalSub = savedSubCategories[itemIndex].sub;
             if(confirm(`確定要將「${savedSubCategories[itemIndex].label}」移出精選嗎？`)) { triggerHaptic(10); savedSubCategories.splice(itemIndex, 1); addXP(XP_FAV); saveAllSettings(); const mainBtns = document.querySelectorAll('#main-grid .category-btn'); let targetMainBtn = Array.from(mainBtns).find(btn => btn.textContent === database[originalMain].label); if (targetMainBtn) { selectMainCategory(originalMain, targetMainBtn); setTimeout(() => { const subBtns = document.querySelectorAll('#sub-grid .category-btn'); let targetSubBtn = Array.from(subBtns).find(btn => btn.textContent === database[originalMain].subs[originalSub].label); if(targetSubBtn) selectSubCategory(originalSub, targetSubBtn); }, 50); } else { const featuredBtn = document.getElementById('btn-show-featured'); selectFeaturedCategory(featuredBtn); } }
        }
        function toggleSavedSubCategory() {
            if (!currentMain || !currentSub) return; triggerHaptic(10);
            const existsIndex = savedSubCategories.findIndex(item => item.main === currentMain && item.sub === currentSub);
            if (existsIndex !== -1) { savedSubCategories.splice(existsIndex, 1); } else { const subLabel = database[currentMain].subs[currentSub].label; savedSubCategories.push({ main: currentMain, sub: currentSub, label: subLabel }); addXP(XP_FAV); }
            saveAllSettings(); updateEmbeddedStarState();
        }

        function showSkeletonLoading() { mainGrid.innerHTML = ''; for (let i = 0; i < 9; i++) { const div = document.createElement('div'); div.className = 'category-btn skeleton'; mainGrid.appendChild(div); } }
        function loadHistory() { const saved = localStorage.getItem('historyLog'); if (saved) { try { historyLog = JSON.parse(saved); } catch (e) { historyLog = []; } } }
        function saveHistory() { localStorage.setItem('historyLog', JSON.stringify(historyLog)); syncToWix(); }
        function addToHistory(text) { if (historyLog.length > 0 && historyLog[0] === text) return; historyLog.unshift(text); if (historyLog.length > 16) historyLog.pop(); saveHistory(); }
        function loadFavorites() { const saved = localStorage.getItem('favorites'); if (saved) { try { favorites = JSON.parse(saved); } catch (e) { favorites = []; } } }
        function toggleFavorite(text, btn) {
            triggerHaptic(10); const index = favorites.indexOf(text);
            if (index === -1) { if (favorites.length >= 24) { alert("我的最愛已滿 (24則)，請先刪除舊的！"); return; } favorites.push(text); btn.classList.add('active'); 
            // SVG Toggle
            btn.innerHTML = '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>';
            addXP(XP_FAV); unlockAchievement("first_fav"); if (favorites.length >= 24) unlockAchievement("fav_full"); } 
            else { favorites.splice(index, 1); btn.classList.remove('active'); 
            // SVG Toggle
            btn.innerHTML = '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.01 4.38.38-3.32 2.88 1 4.28L12 15.4z"/></svg>';
            unlockAchievement("fav_del"); }
            localStorage.setItem('favorites', JSON.stringify(favorites)); syncToWix(); if(currentTab === 'fav') renderHistoryList();
        }
        function removeFavorite(text) { triggerHaptic(10); const index = favorites.indexOf(text); if (index !== -1) { favorites.splice(index, 1); localStorage.setItem('favorites', JSON.stringify(favorites)); syncToWix(); renderHistoryList(); if(currentDisplayState.length > 0) renderFromState(false); unlockAchievement("fav_del"); } }
        function clearFavorites() { if(confirm("確定要清空所有收藏嗎？")) { triggerHaptic(10); favorites = []; localStorage.setItem('favorites', JSON.stringify(favorites)); syncToWix(); renderHistoryList(); if(currentDisplayState.length > 0) renderFromState(false); } }
        function switchTab(tab) { currentTab = tab; document.getElementById('tab-history').classList.toggle('active', tab === 'history'); document.getElementById('tab-fav').classList.toggle('active', tab === 'fav'); document.getElementById('clear-fav-btn').style.display = tab === 'fav' ? 'block' : 'none'; renderHistoryList(); }
        function renderHistoryList() {
            const list = document.getElementById('history-list'); list.innerHTML = ''; const data = currentTab === 'history' ? historyLog : favorites; const emptyText = currentTab === 'history' ? '尚未有複製紀錄' : '尚未有收藏';
            if (data.length === 0) list.innerHTML = `<div class="history-empty">${emptyText}</div>`;
            else { data.forEach(text => { const item = document.createElement('div'); item.className = 'history-item'; 
            item.onclick = (e) => { item.classList.add('clicked'); setTimeout(() => item.classList.remove('clicked'), 150); copyToClipboard(text, e); };
            const textSpan = document.createElement('span'); textSpan.className = 'history-text'; textSpan.textContent = text; item.appendChild(textSpan); if (currentTab === 'fav') { const delBtn = document.createElement('span'); delBtn.className = 'delete-btn'; delBtn.textContent = '🗑️'; delBtn.onclick = (e) => { e.stopPropagation(); removeFavorite(text); }; item.appendChild(delBtn); } list.appendChild(item); }); }
        }
        function openHistory(tab, event) { triggerHaptic(10); const modal = document.getElementById('history-modal'); const content = document.getElementById('modal-content-box'); modal.style.display = 'block'; if (event) { let topPos = event.clientY; if (topPos > window.innerHeight * 0.6) topPos = window.innerHeight * 0.4; content.style.top = topPos + 'px'; } else { content.style.top = '20%'; } switchTab(tab); }
        function closeHistory(event) { if (event && event.target.id !== 'history-modal') return; document.getElementById('history-modal').style.display = 'none'; }
        function speakText(text) { 
            triggerHaptic(10); const cleanText = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, ''); const utterance = new SpeechSynthesisUtterance(cleanText); utterance.lang = 'ja-JP'; utterance.rate = appSettings.voiceRate; utterance.pitch = appSettings.voicePitch; window.speechSynthesis.cancel(); window.speechSynthesis.speak(utterance); 
            sessionData.voiceClickCount++; if (sessionData.voiceClickCount >= 10) unlockAchievement("voice_lover"); if (appSettings.voiceRate >= 1.5) unlockAchievement("rap_god");
        }
        
        function createParticles(x, y) { 
            if (appSettings.pureMode) return; 
            const particles = ['❤️', '⭐', '✨', '            💕']; for(let i=0; i<12; i++) { const p = document.createElement('div'); p.textContent = particles[Math.floor(Math.random()*particles.length)]; p.className = 'particle'; p.style.left = x + 'px'; p.style.top = y + 'px'; p.style.setProperty('--tx', (Math.random()*100 - 50) + 'px'); p.style.setProperty('--ty', (Math.random()*100 - 50) + 'px'); document.body.appendChild(p); setTimeout(() => p.remove(), 800); } 
        }
        
        function renderMainCategories() {
            mainGrid.innerHTML = '';
            // 移除舊的 featuredBtn 生成，現在使用 header 中的靜態按鈕
            Object.keys(database).forEach(key => { 
                const btn = document.createElement('div'); btn.className = 'category-btn'; btn.dataset.key = key;
                let label = database[key].label; if (appSettings.pureMode) label = stripEmojis(label); btn.textContent = label; 
                btn.onclick = (e) => { triggerHaptic(10); selectMainCategory(key, btn); }; 
                mainGrid.appendChild(btn); 
            });
        }
        
        function selectFeaturedCategory(btnElement) { 
            currentMain = 'featured_custom'; currentSub = null; currentDisplayState = []; seenIndices.clear(); resultArea.innerHTML = ''; subGrid.innerHTML = ''; document.querySelector('.sub-placeholder').style.display = 'none'; 
            
            // 清除 Grid 中的 active
            document.querySelectorAll('#main-grid .category-btn').forEach(b => b.classList.remove('active')); 
            
            // 處理 Header 按鈕 Active 狀態
            document.getElementById('btn-show-featured').classList.add('active');
            
            renderFeaturedSubGrid(); 
            updateEmbeddedStarState(); 
            
            // Enable Regen
            regenBtn.classList.remove('disabled');
            updateStatusUI('selected', '精選收藏');
        }
        
        function renderFeaturedSubGrid() { 
            subGrid.innerHTML = ''; 
            // 移除 subGrid.appendChild(createStarButton()); 改用靜態按鈕控制
            
            if (savedSubCategories.length === 0) { document.querySelector('.sub-placeholder').style.display = 'block'; document.querySelector('.sub-placeholder').textContent = "尚未有收藏的細項，請去其他分類點擊「⭐」"; return; } 
            savedSubCategories.forEach(item => { 
                const btn = document.createElement('div'); btn.className = 'category-btn'; btn.dataset.key = item.sub;
                let label = item.label; if (appSettings.pureMode) label = stripEmojis(label); btn.textContent = label; btn.onclick = (e) => { triggerHaptic(10); createParticles(e.clientX, e.clientY); selectSubCategoryFromFeatured(item, btn); }; 
                subGrid.appendChild(btn); 
            }); 
        }
        
        function selectSubCategoryFromFeatured(item, btnElement) { 
            currentMain = 'featured_custom'; currentSub = item.sub; seenIndices.clear(); document.querySelectorAll('#sub-grid .category-btn').forEach(b => b.classList.remove('active')); btnElement.classList.add('active'); updateEmbeddedStarState(); 
            
            // Enable Regen
            regenBtn.classList.remove('disabled'); 
            regenBtn.onclick = (e) => { triggerHaptic(10); generatePhrases(false, e); }; 
            
            updateStatusUI('selected', item.label);

            const originalMain = item.main; const originalSub = item.sub; const targetData = database[originalMain].subs[originalSub]; 
            if(targetData) { const count = Math.min(targetData.phrases.length, appSettings.resultCount); const selectedPhrases = getWeightedRandom(targetData.phrases, count); currentDisplayState = selectedPhrases.map(phrase => ({ base: phrase, emoji: generateEmojiCombo(), specificPos: Math.random() < 0.5 ? 1 : 2 })); renderFromState(true); } 
        }
        
        function selectMainCategory(key, btnElement) { 
            currentMain = key; currentSub = null; currentDisplayState = []; seenIndices.clear(); resultArea.innerHTML = ''; subGrid.innerHTML = ''; document.querySelector('.sub-placeholder').style.display = 'none'; 
            
            // 清除所有 active
            document.querySelectorAll('#main-grid .category-btn').forEach(b => b.classList.remove('active')); 
            document.getElementById('btn-show-featured').classList.remove('active');
            
            btnElement.classList.add('active'); 
            
            // Disable Regen until sub selected
            regenBtn.classList.add('disabled');
            updateStatusUI('idle');

            // 移除 subGrid.appendChild(createStarButton());
            
            const subData = database[key].subs; 
            for (const subKey in subData) { 
                const btn = document.createElement('div'); btn.className = 'category-btn'; btn.dataset.key = subKey;
                let label = subData[subKey].label; if (appSettings.pureMode) label = stripEmojis(label); btn.textContent = label; 
                btn.onclick = (e) => { triggerHaptic(10); createParticles(e.clientX, e.clientY); selectSubCategory(subKey, btn); }; 
                subGrid.appendChild(btn); 
            } 
            updateActionButtonsState(); updateEmbeddedStarState(); 
            
            renderFromState(false); // Show empty state for new category
        }
        
        function selectSubCategory(subKey, btnElement) { 
            currentSub = subKey; seenIndices.clear(); document.querySelectorAll('#sub-grid .category-btn').forEach(b => b.classList.remove('active')); btnElement.classList.add('active'); updateEmbeddedStarState(); 
            
            // Enable Regen
            regenBtn.classList.remove('disabled'); 
            regenBtn.onclick = (e) => { triggerHaptic(10); generatePhrases(false, e); }; 
            
            const subLabel = database[currentMain].subs[subKey].label;
            updateStatusUI('selected', subLabel);

            generatePhrases(true); 
        }
        
        function setEmojiLevel(level, element) { 
            triggerHaptic(10); emojiLevel = level; element.parentNode.querySelectorAll('.control-option').forEach(el => el.classList.remove('active')); element.classList.add('active'); 
            if (level === 'kaomoji') unlockAchievement("kaomoji_fan");
            if (currentDisplayState.length > 0) rerollEmojisOnly(); else if (currentMain && currentSub) generatePhrases(true);
        }
        
        function updateActionButtonsState() { 
            const hasPhrases = currentDisplayState.length > 0; 
            const emojiBtn = document.getElementById('emoji-reroll-btn'); // 修改2: 狀態連動
            
            if (hasPhrases) { 
                // Regen state is controlled by selection now
                // regenBtn.classList.remove('disabled'); 
                if(emojiBtn) emojiBtn.classList.remove('disabled');
                aiBatchBtn.classList.remove('disabled'); 
            } else { 
                regenBtn.classList.add('disabled'); 
                if(emojiBtn) emojiBtn.classList.add('disabled');
                aiBatchBtn.classList.add('disabled'); 
            } 
        }
        
        function searchPhrases() { 
            triggerHaptic(10); const query = searchInput.value.trim().toLowerCase(); if (!query) return; 
            unlockAchievement("first_search");
            currentMain = null; currentSub = null; seenIndices.clear(); 
            
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active')); 
            document.getElementById('btn-show-featured').classList.remove('active');
            
            subGrid.innerHTML = ''; document.querySelector('.sub-placeholder').style.display = 'block'; document.querySelector('.sub-placeholder').textContent = `🔍 搜尋結果：${query}`; const matches = []; Object.values(database).forEach(main => { Object.values(main.subs).forEach(sub => { sub.phrases.forEach(p => { if (p.jp.toLowerCase().includes(query) || p.cn.toLowerCase().includes(query)) matches.push(p); }); }); }); if (matches.length === 0) { alert("找不到相關結果，請換個關鍵字試試！"); return; } currentSearchMatches = matches; refreshSearch(true); 
        }
        function getWeightedRandom(sourceArr, count) { let pool = sourceArr.map((item, index) => ({ item: item, index: index, weight: seenIndices.has(index) ? 25 : 100 })); let result = []; for (let i = 0; i < count; i++) { if (pool.length === 0) break; let totalWeight = pool.reduce((a, b) => a + b.weight, 0), r = Math.random() * totalWeight, selectedIdx = -1; for (let j = 0; j < pool.length; j++) { r -= pool[j].weight; if (r <= 0) { selectedIdx = j; break; } } if (selectedIdx === -1) selectedIdx = pool.length - 1; result.push(pool[selectedIdx].item); seenIndices.add(pool[selectedIdx].index); pool.splice(selectedIdx, 1); } return result; }
        function refreshSearch(animate = true) { if (currentSearchMatches.length === 0) return; const count = Math.min(currentSearchMatches.length, appSettings.resultCount); const selectedPhrases = getWeightedRandom(currentSearchMatches, count); currentDisplayState = selectedPhrases.map(phrase => ({ base: phrase, emoji: generateEmojiCombo(), specificPos: Math.random() < 0.5 ? 1 : 2 })); renderFromState(animate); regenBtn.classList.remove('disabled'); regenBtn.onclick = (e) => { triggerHaptic(10); refreshSearch(false); if(e) createParticles(e.clientX, e.clientY); }; }
        
        function generateEmojiCombo() {
            if (emojiLevel === 'kaomoji') return kaomojiList.length > 0 ? " " + kaomojiList[Math.floor(Math.random() * kaomojiList.length)] : "";
            if (emojiLevel === 0) return punctuations[Math.floor(Math.random() * punctuations.length)];
            const facesPool = activeFaces.length > 0 ? activeFaces : defaultFaces; const decorPool = activeDecor.length > 0 ? activeDecor : defaultDecor;
            if (emojiLevel === 3) { const count = Math.floor(Math.random() * 3) + 1; const selectedDecor = decorPool[Math.floor(Math.random() * decorPool.length)]; let result = facesPool[Math.floor(Math.random() * facesPool.length)]; for (let i = 1; i < count; i++) result += selectedDecor; return " " + result; }
            let count; if (emojiLevel === 1) { count = (Math.floor(Math.random() * 2) + 1); } else if (emojiLevel === 2) { const min = parseInt(appSettings.customMin); const max = parseInt(appSettings.customMax); count = Math.floor(Math.random() * (max - min + 1)) + min; } else { count = (Math.floor(Math.random() * 2) + 3); }
            const featurePool = [...facesPool, ...decorPool]; const featureEmoji = featurePool[Math.floor(Math.random() * featurePool.length)]; const selectedDecor = decorPool[Math.floor(Math.random() * decorPool.length)]; let result = featureEmoji; for (let i = 1; i < count; i++) result += selectedDecor; return " " + result;
        }
        
        function generatePhrases(animate = true, event = null) { 
            if (!currentMain || !currentSub) return; 
            if (event) { createParticles(event.clientX, event.clientY); sessionData.regenStreak++; if (sessionData.regenStreak >= 20) unlockAchievement("regen_20"); } else { sessionData.regenStreak = 0; }
            if (currentSub === "🔞 紳士讚美") { sessionData.eroticStreak++; if (sessionData.eroticStreak >= 10) unlockAchievement("erotic_fan"); } else { sessionData.eroticStreak = 0; }
            if (currentSub === "🥰 單純可愛") { sessionData.cuteStreak++; if (sessionData.cuteStreak >= 10) unlockAchievement("pure_love"); } else { sessionData.cuteStreak = 0; }

            if (currentMain !== 'featured_custom') { 
                const targetData = database[currentMain].subs[currentSub]; const count = Math.min(targetData.phrases.length, appSettings.resultCount); const selectedPhrases = getWeightedRandom(targetData.phrases, count); 
                currentDisplayState = selectedPhrases.map(phrase => ({ base: phrase, emoji: generateEmojiCombo(), specificPos: Math.random() < 0.5 ? 1 : 2 })); 
                renderFromState(animate); 
            } else { 
                const item = savedSubCategories.find(i => i.sub === currentSub); 
                if (item) { 
                    const targetData = database[item.main].subs[item.sub]; const count = Math.min(targetData.phrases.length, appSettings.resultCount); const selectedPhrases = getWeightedRandom(targetData.phrases, count); 
                    currentDisplayState = selectedPhrases.map(phrase => ({ base: phrase, emoji: generateEmojiCombo(), specificPos: Math.random() < 0.5 ? 1 : 2 })); 
                    renderFromState(animate); 
                } 
            } 
            regenBtn.classList.remove('disabled'); 
            regenBtn.onclick = (e) => { 
                if (currentMain === "自訂生成" && currentSub === "回覆生成") {
                    handleReplyGen();
                } else if (currentMain === "自訂生成") {
                    handleCustomAiGen();
                } else {
                    generatePhrases(false, e); 
                }
                triggerHaptic(10);
            }; 
            resetAiButton(); 
        }
        
        function rerollEmojisOnly(event = null) { 
            if (currentDisplayState.length === 0) { generatePhrases(true); return; }
            triggerHaptic(10); if (event) createParticles(event.clientX, event.clientY); 
            currentDisplayState.forEach(item => { item.emoji = generateEmojiCombo(); }); 
            renderFromState(false); 
        }

        function renderList() {
            if (currentTab === 'history' || currentTab === 'fav') {
                renderHistoryList();
            }
        }

        function renderFromState(animate = true) {
            resultArea.innerHTML = '';
            
            if (currentDisplayState.length === 0) {
                // Render Empty State
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = `
                    <svg class="empty-icon-svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 11H7V9h2v2zm4 0h-2V9h2v2zm4 0h-2V9h2v2z"/></svg>
                    <div>等待紳士指令...</div>
                `;
                resultArea.appendChild(emptyDiv);
                updateActionButtonsState();
                return;
            }

            currentDisplayState.forEach((item, index) => {
                let jpBase = item.base.jp; let emojiPart = item.emoji; let cnBase = item.base.cn;
                let jpDisplay = jpBase + emojiPart; let cnDisplay = cnBase; let jpCopy = jpDisplay; 
                
                const div = document.createElement('div'); div.className = 'result-item'; 
                if (animate) { div.classList.add('animate-in'); div.style.animationDelay = `${index * 0.05}s`; } else div.classList.add('fade-in');
                const isFav = favorites.includes(jpCopy); const starClass = isFav ? 'active' : ''; const starChar = isFav ? '★' : '☆';
                
                // SVG logic for star
                const starSVG = isFav ? 
                    '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>' :
                    '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.01 4.38.38-3.32 2.88 1 4.28L12 15.4z"/></svg>';

                div.innerHTML = `
                    <div class="result-left" id="text-${index}" onclick="handleResultClick('${jpCopy.replace(/'/g, "\\'")}', event)">${jpDisplay}</div>
                    <div class="result-actions">
                        <div class="action-icon icon-speak" id="speak-${index}" onclick="speakText('${jpCopy.replace(/'/g, "\\'")}')">
                            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                        </div>
                        <div class="action-icon icon-star ${starClass}" id="star-${index}" onclick="toggleFavorite('${jpCopy.replace(/'/g, "\\'")}', this)">${starSVG}</div>
                    </div>
                    <div class="result-right" id="cn-${index}">${cnDisplay}</div>
                `;
                resultArea.appendChild(div);
            });
            updateActionButtonsState();
            syncToWix(); 
        }
        
        function handleResultClick(text, event) {
            triggerHaptic(50);
            if (event) {
                createParticles(event.clientX, event.clientY);
                const target = event.target.closest('.result-item');
                if (target) { target.classList.add('clicked'); setTimeout(() => target.classList.remove('clicked'), 150); }
            }
            copyToClipboard(text); addXP(XP_COPY);
        }

        function copyToClipboard(text, event) {
            addToHistory(text);
            unlockAchievement("first_copy"); appSettings.totalCopies++; if (appSettings.totalCopies >= 50) unlockAchievement("copy_50"); if (appSettings.totalCopies >= 500) unlockAchievement("copy_500");
            const now = Date.now(); if (now - sessionData.lastCopyTime < 10000) { sessionData.comboCount++; if (sessionData.comboCount >= 5) unlockAchievement("combo_master"); } else { sessionData.comboCount = 1; } sessionData.lastCopyTime = now; checkTimeAchievements();
            window.parent.postMessage({ type: 'TRACK_COPY', payload: text }, "*");
            if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(text).then(showToast).catch((err) => fallbackCopy(text)); } else fallbackCopy(text);
        }
        
        function fallbackCopy(text) { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.left = "0"; textArea.style.top = "0"; textArea.style.width = "1px"; textArea.style.height = "1px"; textArea.style.padding = "0"; textArea.style.border = "none"; textArea.style.outline = "none"; textArea.style.boxShadow = "none"; textArea.style.background = "transparent"; document.body.appendChild(textArea); textArea.focus({preventScroll: true}); textArea.select(); try { const successful = document.execCommand('copy'); if(successful) showToast(); } catch (err) { alert("複製失敗，請手動複製內容"); } document.body.removeChild(textArea); }
        
        function showToast(msg) { 
            toast.textContent = msg || "✅ 已複製內容！"; toast.className = "toast show"; 
            if(window.toastTimeout) clearTimeout(window.toastTimeout); 
            window.toastTimeout = setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 1500); 
        }

        function showAchieveDetail(key, event) {
            triggerHaptic(10); const def = ACHIEVEMENTS[key]; const data = userAchieve[key];
            document.getElementById('detail-icon').innerHTML = def.icon; document.getElementById('detail-title').textContent = def.title; document.getElementById('detail-desc').textContent = def.desc;
            const d = new Date(data.date); document.getElementById('detail-date').textContent = `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
            const modal = document.getElementById('achieve-detail-modal'); const content = modal.querySelector('.achieve-detail-card');
            modal.style.display = 'block';
            const cardW = 280; const cardH = 320; const winW = window.innerWidth; const winH = window.innerHeight;
            let clickY = event ? event.clientY : winH/2; let finalLeft = (winW - cardW) / 2; let finalTop = clickY - (cardH / 2);
            if (finalTop + cardH > winH - 20) { finalTop = winH - cardH - 20; } if (finalTop < 20) finalTop = 20;
            content.style.left = finalLeft + 'px'; content.style.top = finalTop + 'px';
        }
        function closeAchieveDetail() { document.getElementById('achieve-detail-modal').style.display = 'none'; }
        function saveAchieveCard() {
            triggerHaptic(10); const element = document.getElementById('achieve-capture-target'); const originalRadius = element.style.borderRadius; element.style.borderRadius = "0"; 
            html2canvas(element, { backgroundColor: null, scale: 3 }).then(canvas => {
                element.style.borderRadius = originalRadius; const link = document.createElement('a'); link.download = `achievement_${Date.now()}.png`; link.href = canvas.toDataURL('image/png'); link.click(); showToast("📸 成就卡片已儲存！");
            });
        }
        
        document.getElementById('custom-gen-input').addEventListener("keypress", function(event) {
            if (event.key === "Enter") handleCustomAiGen();
        });

        // 修改1: 自訂生成時禁用換一批按鈕，但保留文字
        function handleCustomAiGen() {
            const inputEl = document.getElementById('custom-gen-input');
            const btnEl = document.getElementById('btn-custom-gen');
            const val = inputEl.value.trim();

            if (!val) {
                showToast("⚠️ 請先輸入想要生成的關鍵字！");
                inputEl.focus();
                return;
            }

            const MAX_PER_MINUTE = 5; 
            const now = Date.now();
            if (now - window._aiStartTime > 60000) { window._aiCount = 0; window._aiStartTime = now; }
            if (window._aiCount === 0) window._aiStartTime = now;

            if (window._aiCount >= MAX_PER_MINUTE) {
                showLockedTooltip(btnEl, "休息一下，靈感正在冷卻中 🧊");
                return;
            }
            window._aiCount++;

            triggerHaptic(20);
            btnEl.classList.add('disabled');
            btnEl.innerHTML = '詠唱中...';
            inputEl.blur(); 

            const count = appSettings.resultCount;
            currentDisplayState = [];
            
            for(let i=0; i<count; i++) {
                currentDisplayState.push({
                    base: { jp: val, cn: "AI 正在構思色色的描述..." }, 
                    emoji: generateEmojiCombo(),
                    specificPos: 1
                });
            }

            currentMain = "自訂生成";
            currentSub = val; 
            
            renderFromState(true);
            
            // Disable Refresh
            regenBtn.classList.add('disabled'); 
            updateStatusUI('keyword_gen');
            
            const phrasesToRewrite = new Array(count).fill(val);

            window.parent.postMessage({
                type: 'REQUEST_BATCH_AI',
                phrases: phrasesToRewrite,
                context: { main: "使用者自訂", sub: val }
            }, "*");

            unlockAchievement("ai_awakening");

            setTimeout(() => {
                if (btnEl.classList.contains('disabled')) {
                    btnEl.classList.remove('disabled');
                    btnEl.innerHTML = 'AI生成';
                }
            }, 15000);
        }

        // 修改1: 回覆生成時禁用換一批按鈕，但保留文字
        function handleReplyGen() {
            const inputEl = document.getElementById('custom-gen-input'); 
            const replyBtn = document.getElementById('btn-reply-gen');
            const userContent = inputEl.value.trim(); 

            if (!userContent) {
                showToast("⚠️ 請先輸入或貼上要回覆的內容！");
                inputEl.focus();
                return;
            }

            const MAX_PER_MINUTE = 5; 
            const now = Date.now();
            if (now - window._aiStartTime > 60000) { window._aiCount = 0; window._aiStartTime = now; }
            if (window._aiCount === 0) window._aiStartTime = now;

            if (window._aiCount >= MAX_PER_MINUTE) {
                showLockedTooltip(replyBtn, "休息一下，靈感正在冷卻中 🧊");
                return;
            }
            window._aiCount++;

            triggerHaptic(20);
            
            if(replyBtn) {
                replyBtn.classList.add('disabled');
                replyBtn.innerHTML = '思考中...';
            }
            inputEl.blur(); 

            const count = appSettings.resultCount;
            currentDisplayState = [];
            
            // 修改3: 讓使用者輸入的內容顯示在左側
            for(let i=0; i<count; i++) {
                currentDisplayState.push({
                    base: { jp: userContent, cn: "AI 繪師正在構思回覆..." }, 
                    emoji: generateEmojiCombo(),
                    specificPos: 1
                });
            }

            currentMain = "自訂生成";
            currentSub = "回覆生成"; 
            
            renderFromState(true);
            
            // Disable Refresh
            regenBtn.classList.add('disabled'); 
            updateStatusUI('reply_gen');

            const phrasesToRewrite = new Array(count).fill(userContent);

            window.parent.postMessage({
                type: 'REQUEST_BATCH_AI',
                phrases: phrasesToRewrite,
                context: { main: "ReplyMode", sub: "ArtistReply" } 
            }, "*");

            unlockAchievement("ai_awakening");

            setTimeout(() => {
                if (replyBtn && replyBtn.classList.contains('disabled')) {
                    replyBtn.classList.remove('disabled');
                    replyBtn.innerHTML = 'AI 回覆';
                }
            }, 15000);
        }

        const originalResetAiButton = resetAiButton;
        resetAiButton = function() {
            if (typeof originalResetAiButton === 'function') originalResetAiButton();
            const customBtn = document.getElementById('btn-custom-gen');
            const replyBtn = document.getElementById('btn-reply-gen');
            if (customBtn) {
                customBtn.classList.remove('disabled');
                customBtn.innerHTML = 'AI生成';
            }
            if (replyBtn) {
                replyBtn.classList.remove('disabled');
                replyBtn.innerHTML = 'AI 回覆';
            }
            // Do NOT re-enable Regen automatically
        };

        init();
    </script>
</body>
</html>